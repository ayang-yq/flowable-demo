# æ”¯ä»˜ç¯èŠ‚UIä¸BPMNå­æµç¨‹è”åŠ¨é—®é¢˜åˆ†æ

## ä¸€ã€å½“å‰æ¶æ„æ¦‚è¿°

### 1.1 BPMNæ”¯ä»˜æµç¨‹ï¼ˆClaimPaymentProcess.bpmnï¼‰

```
æ”¯ä»˜å¼€å§‹ â†’ æ”¯ä»˜æ ¡éªŒ â†’ [ç½‘å…³] â†’ æ‰§è¡Œæ”¯ä»˜ â†’ æ”¯ä»˜ç¡®è®¤ â†’ [ç½‘å…³] â†’ æ›´æ–°Case â†’ å‘é€é€šçŸ¥ â†’ ç»“æŸ
                              â†“                                â†“
                          æ”¯ä»˜è¢«æ‹’ç» â†’ æ›´æ–°Case â†’ å‘é€é€šçŸ¥      å¤„ç†äº‰è®® â†’ [å†³ç­–]
                                                                                â†“
                                                                        é‡è¯•/å–æ¶ˆ/è°ƒæŸ¥
```

**åŒ…å«çš„ä»»åŠ¡èŠ‚ç‚¹ï¼š**
- `userTask_validatePayment` - æ”¯ä»˜æ ¡éªŒï¼ˆéœ€è¦paymentOfficerå¤„ç†ï¼‰
- `serviceTask_executePayment` - æ‰§è¡Œæ”¯ä»˜ï¼ˆè‡ªåŠ¨æœåŠ¡ï¼‰
- `userTask_confirmPayment` - æ”¯ä»˜ç¡®è®¤ï¼ˆéœ€è¦paymentOfficerå¤„ç†ï¼‰
- `userTask_paymentRejected` - æ”¯ä»˜è¢«æ‹’ç»ï¼ˆéœ€è¦paymentOfficerå¤„ç†ï¼‰
- `userTask_handleDispute` - å¤„ç†æ”¯ä»˜äº‰è®®ï¼ˆéœ€è¦paymentManagerå¤„ç†ï¼‰
- `serviceTask_updateCase` - æ›´æ–°CaseçŠ¶æ€ï¼ˆè‡ªåŠ¨æœåŠ¡ï¼‰
- `serviceTask_sendNotification` - å‘é€é€šçŸ¥ï¼ˆè‡ªåŠ¨æœåŠ¡ï¼‰

### 1.2 CMMNæ¡ˆä¾‹æ¨¡å‹ï¼ˆClaimCase.cmmnï¼‰

```
Approval Stage (æœ€ç»ˆå®¡æ‰¹) 
    â†“ (approved=true)
Payment Stage (æ”¯ä»˜)
    â†“
    â””â”€ ProcessTask: taskProcessPayment
         â””â”€ å¼•ç”¨BPMNæµç¨‹: ClaimPaymentProcess
    â†“ (complete)
Closure Stage (å…³é—­)
```

### 1.3 å‰ç«¯UIç»“æ„

#### 1.3.1 ç†èµ”è¯¦æƒ…é¡µï¼ˆClaimDetail.tsxï¼‰

**å½“å‰å®ç°ï¼š**
- çŠ¶æ€ï¼š`APPROVED` æ—¶æ˜¾ç¤º"æ”¯ä»˜"æŒ‰é’®
- ç‚¹å‡»åå¼¹å‡ºæ”¯ä»˜æ¨¡æ€æ¡†
- æ¨¡æ€æ¡†å­—æ®µï¼š
  - æ”¯ä»˜é‡‘é¢
  - æ”¯ä»˜æ—¥æœŸ
  - æ”¯ä»˜æ–¹å¼
  - æ”¯ä»˜å‚è€ƒå·
- è°ƒç”¨ï¼š`claimApi.payClaim()` ç›´æ¥å®Œæˆæ”¯ä»˜

```typescript
// ClaimDetail.tsx ä¸­çš„æ”¯ä»˜é€»è¾‘
{claim.status === 'APPROVED' && (
  <Button 
    type="primary" 
    icon={<DollarOutlined />}
    onClick={() => setPaymentModalVisible(true)}
  >
    æ”¯ä»˜
  </Button>
)}

const handlePay = async (values: any) => {
  const paymentData = {
    paymentAmount: values.paymentAmount,
    paymentDate: values.paymentDate || new Date().toISOString().split('T')[0],
    paymentMethod: values.paymentMethod,
    paymentReference: values.paymentReference || `PAY-${new Date().toISOString().split('T')[0]}-${id?.substring(0, 8)}`,
    userId: user?.id || 'admin'
  };
  
  await claimApi.payClaim(id!, paymentData);
  message.success('æ”¯ä»˜æˆåŠŸ');
  // åˆ·æ–°æ•°æ®
  loadClaimDetail();
  loadTasks();
};
```

#### 1.3.2 ä»»åŠ¡åˆ—è¡¨é¡µï¼ˆTaskList.tsxï¼‰

**å½“å‰å®ç°ï¼š**
- æ˜¾ç¤ºæ‰€æœ‰å¾…åŠä»»åŠ¡ï¼ŒåŒ…æ‹¬BPMNæ”¯ä»˜æµç¨‹ä¸­çš„å››ä¸ªç”¨æˆ·ä»»åŠ¡ï¼š
  - `userTask_validatePayment` - æ”¯ä»˜æ ¡éªŒ
  - `userTask_confirmPayment` - æ”¯ä»˜ç¡®è®¤
  - `userTask_paymentRejected` - æ”¯ä»˜è¢«æ‹’ç»
  - `userTask_handleDispute` - å¤„ç†æ”¯ä»˜äº‰è®®
- æ¯ä¸ªä»»åŠ¡æœ‰ç‹¬ç«‹çš„å¤„ç†æ¨¡æ€æ¡†
- é€šè¿‡`taskApi.completeTask(taskId, variables)`å®Œæˆä»»åŠ¡

```typescript
// TaskList.tsx ä¸­çš„ä»»åŠ¡å¤„ç†é€»è¾‘
const handleCompleteTask = async (taskId: string, task?: FlowableTask) => {
  const taskToProcess = task || myTasks.find(t => t.id === taskId);
  
  if (!taskToProcess) {
    message.error('ä»»åŠ¡ä¸å­˜åœ¨');
    return;
  }

  // æ ¹æ®ä»»åŠ¡ç±»å‹å¤„ç†
  switch (taskToProcess.taskDefinitionKey) {
    case 'userTask_validatePayment':
      setSelectedTaskForProcessing(taskToProcess);
      await loadTaskVariables(taskId);
      setValidationModalVisible(true);
      break;
    
    case 'userTask_confirmPayment':
      setSelectedTaskForProcessing(taskToProcess);
      await loadTaskVariables(taskId);
      setConfirmModalVisible(true);
      break;
    
    case 'userTask_paymentRejected':
      setSelectedTaskForProcessing(taskToProcess);
      setRejectedModalVisible(true);
      break;
    
    case 'userTask_handleDispute':
      setSelectedTaskForProcessing(taskToProcess);
      setDisputeModalVisible(true);
      break;
    
    default:
      // æ™®é€šä»»åŠ¡ï¼Œç›´æ¥å®Œæˆ
      await taskApi.completeTask(taskId);
      message.success('å®Œæˆä»»åŠ¡æˆåŠŸ');
      loadMyTasks();
      loadClaimableTasks();
  }
};
```

---

## äºŒã€è¯†åˆ«çš„ä¸»è¦é—®é¢˜

### 2.1 ä¸¤å¥—ç‹¬ç«‹çš„æ”¯ä»˜æµç¨‹

#### é—®é¢˜1ï¼šç†èµ”è¯¦æƒ…é¡µçš„æ”¯ä»˜ç»•è¿‡BPMNæµç¨‹

**ç°çŠ¶ï¼š**
- ç†èµ”è¯¦æƒ…é¡µç‚¹å‡»"æ”¯ä»˜"æŒ‰é’® â†’ è°ƒç”¨`claimApi.payClaim()` â†’ ç›´æ¥å®Œæˆæ”¯ä»˜
- **ä¸ç»è¿‡**BPMNæ”¯ä»˜æµç¨‹çš„ä»»ä½•æ­¥éª¤

**å½±å“ï¼š**
- æ”¯ä»˜æ ¡éªŒè¢«è·³è¿‡
- æ”¯ä»˜ç¡®è®¤è¢«è·³è¿‡
- æ— æ³•è¿½è¸ªæ”¯ä»˜çŠ¶æ€
- BPMNæµç¨‹ä¸­çš„ä»»åŠ¡æ°¸è¿œä¸ä¼šç”Ÿæˆ

**ä»£ç è¯æ®ï¼š**
```typescript
// ClaimDetail.tsx - ç›´æ¥è°ƒç”¨æ”¯ä»˜API
await claimApi.payClaim(id!, paymentData);
message.success('æ”¯ä»˜æˆåŠŸ');
```

#### é—®é¢˜2ï¼šä»»åŠ¡åˆ—è¡¨é¡µå¤„ç†BPMNæ”¯ä»˜ä»»åŠ¡

**ç°çŠ¶ï¼š**
- ç”¨æˆ·åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­çœ‹åˆ°æ”¯ä»˜æ ¡éªŒã€æ”¯ä»˜ç¡®è®¤ç­‰ä»»åŠ¡
- è¿™äº›ä»»åŠ¡æ˜¯åœ¨BPMNæµç¨‹ä¸­æ­£å¸¸ç”Ÿæˆçš„ï¼ˆå‡è®¾æµç¨‹è¢«æ­£ç¡®è§¦å‘ï¼‰
- ä½†ç”±äºé—®é¢˜1ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½æ°¸è¿œä¸ä¼šå‡ºç°

**å½±å“ï¼š**
- å¦‚æœBPMNæµç¨‹è¢«è§¦å‘ï¼Œä¼šæœ‰ä¸¤å¥—å¹¶è¡Œçš„æ”¯ä»˜æ“ä½œæ–¹å¼
- ç”¨æˆ·ä¸çŸ¥é“åº”è¯¥ç”¨å“ªç§æ–¹å¼
- å¯èƒ½å¯¼è‡´é‡å¤æ”¯ä»˜æˆ–çŠ¶æ€ä¸ä¸€è‡´

### 2.2 çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜

#### é—®é¢˜3ï¼šç†èµ”çŠ¶æ€ä¸BPMNæµç¨‹çŠ¶æ€ä¸åŒæ­¥

**ç†èµ”è¯¦æƒ…é¡µçŠ¶æ€ï¼š**
```
SUBMITTED â†’ UNDER_REVIEW â†’ APPROVED â†’ PAID â†’ CLOSED
```

**BPMNæ”¯ä»˜æµç¨‹çŠ¶æ€ï¼š**
```
æ”¯ä»˜æ ¡éªŒ â†’ æ‰§è¡Œæ”¯ä»˜ â†’ æ”¯ä»˜ç¡®è®¤ â†’ æ›´æ–°Case â†’ å‘é€é€šçŸ¥
       â†“
   æ”¯ä»˜è¢«æ‹’ç»
```

**é—®é¢˜ï¼š**
- ç†èµ”çŠ¶æ€åœ¨`APPROVED`æ—¶æ˜¾ç¤º"æ”¯ä»˜"æŒ‰é’®
- ä½†æ­¤æ—¶BPMNæµç¨‹å¯èƒ½è¿˜æ²¡æœ‰å¯åŠ¨
- æˆ–è€…BPMNæµç¨‹å·²ç»å¯åŠ¨ï¼Œä½†ç†èµ”çŠ¶æ€è¿˜æ˜¯`APPROVED`
- ä¸¤ä¸ªçŠ¶æ€ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹ï¼Œæ²¡æœ‰è”åŠ¨

#### é—®é¢˜4ï¼šæ”¯ä»˜ä¿¡æ¯çš„å†—ä½™å­˜å‚¨

**ç†èµ”è¯¦æƒ…é¡µå­˜å‚¨çš„æ”¯ä»˜ä¿¡æ¯ï¼š**
```typescript
interface ClaimCase {
  approvedAmount: number;
  paidAmount: number;
  paymentDate?: string;
  paymentMethod?: string;
  paymentReference?: string;
}
```

**BPMNæµç¨‹ä¸­çš„æ”¯ä»˜ä¿¡æ¯ï¼š**
```xml
<flowable:in source="amount" target="amount" />
<flowable:in source="reference" target="reference" />
<flowable:in source="payeeName" target="payeeName" />
<flowable:in source="caseInstanceId" target="caseInstanceId" />
```

**é—®é¢˜ï¼š**
- åŒä¸€ä¿¡æ¯åœ¨ä¸¤ä¸ªåœ°æ–¹å­˜å‚¨
- æ›´æ–°æ—¶ä¸åŒæ­¥
- æ•°æ®å¯èƒ½ä¸ä¸€è‡´

### 2.3 ç”¨æˆ·ä½“éªŒé—®é¢˜

#### é—®é¢˜5ï¼šæ”¯ä»˜æ“ä½œçš„åˆ†æ•£æ€§

**åœºæ™¯1ï¼šç”¨æˆ·åœ¨ç†èµ”è¯¦æƒ…é¡µ**
- çœ‹åˆ°"æ”¯ä»˜"æŒ‰é’®
- ç‚¹å‡»åå¡«å†™æ”¯ä»˜ä¿¡æ¯
- æäº¤åæ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"
- ä½†çœ‹ä¸åˆ°æ”¯ä»˜è¿›åº¦

**åœºæ™¯2ï¼šç”¨æˆ·åœ¨ä»»åŠ¡åˆ—è¡¨é¡µ**
- çœ‹åˆ°"æ”¯ä»˜æ ¡éªŒ"ä»»åŠ¡
- ç‚¹å‡»å¤„ç†ï¼Œæ‰¹å‡†æ”¯ä»˜
- éšåçœ‹åˆ°"æ”¯ä»˜ç¡®è®¤"ä»»åŠ¡
- ç‚¹å‡»ç¡®è®¤
- å®Œæˆæ”¯ä»˜

**é—®é¢˜ï¼š**
- ç”¨æˆ·ä¸çŸ¥é“åº”è¯¥ç”¨å“ªä¸ªé¡µé¢
- æ“ä½œæµç¨‹ä¸æ¸…æ™°
- æ”¯ä»˜çŠ¶æ€ä¸é€æ˜

#### é—®é¢˜6ï¼šç¼ºå°‘æ”¯ä»˜è¿›åº¦å¯è§†åŒ–

**ç°çŠ¶ï¼š**
- ç†èµ”è¯¦æƒ…é¡µåªæœ‰ç®€å•çš„çŠ¶æ€æ ‡ç­¾
- çœ‹ä¸åˆ°BPMNæµç¨‹çš„æ‰§è¡Œè¿›åº¦
- ä¸çŸ¥é“æ”¯ä»˜å¤„äºå“ªä¸ªé˜¶æ®µ

**æœŸæœ›ï¼š**
- æ˜¾ç¤ºæ”¯ä»˜è¿›åº¦æ¡
- é«˜äº®å½“å‰æ”¯ä»˜é˜¶æ®µ
- æä¾›æµç¨‹å¯è§†åŒ–

### 2.4 æµç¨‹æ§åˆ¶é—®é¢˜

#### é—®é¢˜7ï¼šå®¡æ‰¹åè‡ªåŠ¨å¯åŠ¨BPMNæµç¨‹çš„æ—¶æœºä¸æ˜ç¡®

**CMMNé…ç½®ï¼š**
```xml
<cmmn:sentry id="sentryPaymentEntry">
  <cmmn:planItemOnPart sourceRef="planItemTaskFinalApproval">
    <cmmn:standardEvent>complete</cmmn:standardEvent>
  </cmmn:planItemOnPart>
  <cmmn:ifPart>
    <cmmn:condition><![CDATA[${approved == true}]]></cmmn:condition>
  </cmmn:ifPart>
</cmmn:sentry>
```

**é—®é¢˜ï¼š**
- å½“æœ€ç»ˆå®¡æ‰¹å®Œæˆä¸”`approved=true`æ—¶ï¼Œåº”è¯¥è‡ªåŠ¨å¯åŠ¨Payment Stage
- ä½†å‰ç«¯ç›´æ¥è°ƒç”¨`claimApi.payClaim()`å¯èƒ½ç»•è¿‡äº†è¿™ä¸ªæµç¨‹
- BPMNæµç¨‹å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®å¯åŠ¨

#### é—®é¢˜8ï¼šæµç¨‹å˜é‡çš„ä¼ é€’ä¸å®Œæ•´

**CMMNåˆ°BPMNçš„å˜é‡ä¼ é€’ï¼š**
```xml
<cmmn:processTask id="taskProcessPayment" name="Process Claim Payment">
  <cmmn:extensionElements>
    <flowable:in source="amount" target="amount" />
    <flowable:in source="reference" target="reference" />
    <flowable:in source="payeeName" target="payeeName" />
    <flowable:in source="claimId" target="claimId" />
    <flowable:in source="paymentOfficer" target="paymentOfficer" />
    <flowable:in source="paymentManager" target="paymentManager" />
    <flowable:in source="caseInstanceId" target="caseInstanceId" />
    <flowable:out source="paymentStatus" target="paymentStatus" />
  </cmmn:extensionElements>
</cmmn:processTask>
```

**é—®é¢˜ï¼š**
- `amount`ã€`reference`ã€`payeeName`ç­‰å˜é‡éœ€è¦åœ¨CMMNä¸­é¢„å…ˆè®¾ç½®
- ä½†å‰ç«¯ç›´æ¥è°ƒç”¨`claimApi.payClaim()`æ—¶ï¼Œè¿™äº›å˜é‡å¯èƒ½ä¸å­˜åœ¨
- å¯¼è‡´BPMNæµç¨‹å¯åŠ¨å¤±è´¥æˆ–æ‰§è¡Œå¼‚å¸¸

---

## ä¸‰ã€æ ¹æœ¬åŸå› åˆ†æ

### 3.1 æ¶æ„è®¾è®¡é—®é¢˜

#### åŸå› 1ï¼šä¸¤å¥—å¹¶è¡Œä½†ä¸è”åŠ¨çš„æ”¯ä»˜ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç†èµ”è¯¦æƒ…é¡µæ”¯ä»˜      â”‚         â”‚  BPMNæ”¯ä»˜æµç¨‹         â”‚
â”‚  (ClaimDetail)     â”‚         â”‚  (ClaimPayment)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç›´æ¥è°ƒç”¨æ”¯ä»˜API    â”‚         â”‚  æ”¯ä»˜æ ¡éªŒä»»åŠ¡        â”‚
â”‚  çŠ¶æ€: APPROVED     â”‚         â”‚  æ‰§è¡Œæ”¯ä»˜æœåŠ¡        â”‚
â”‚  â†’ PAID            â”‚         â”‚  æ”¯ä»˜ç¡®è®¤ä»»åŠ¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  æ›´æ–°CaseçŠ¶æ€        â”‚
                                â”‚  å‘é€é€šçŸ¥æœåŠ¡        â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜ï¼š**
- ä¸¤å¥—ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹
- æ²¡æœ‰ç»Ÿä¸€çš„å…¥å£å’Œæµç¨‹
- ç”¨æˆ·ä¸çŸ¥é“åº”è¯¥ç”¨å“ªä¸ª

#### åŸå› 2ï¼šCMMNä¸BPMNçš„é›†æˆæœªåœ¨UIå±‚ä½“ç°

**CMMNè®¾è®¡ï¼š**
- ä½¿ç”¨ProcessTaskè°ƒç”¨BPMNå­æµç¨‹
- ç†è®ºä¸Šæ˜¯æ­£ç¡®çš„é›†æˆæ–¹å¼

**UIå®ç°ï¼š**
- å®Œå…¨å¿½ç•¥äº†è¿™ä¸ªè®¾è®¡
- ç†èµ”è¯¦æƒ…é¡µç›´æ¥è°ƒç”¨æ”¯ä»˜API
- æ²¡æœ‰åˆ©ç”¨CMMNçš„æµç¨‹æ§åˆ¶èƒ½åŠ›

### 3.2 æ•°æ®æµé—®é¢˜

#### åŸå› 3ï¼šæ”¯ä»˜ä¿¡æ¯åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å­˜å‚¨

```
ClaimCaseæ•°æ®åº“è¡¨          BPMNæµç¨‹å˜é‡
â”œâ”€ approvedAmount         â”œâ”€ amount
â”œâ”€ paidAmount             â”œâ”€ reference
â”œâ”€ paymentDate            â”œâ”€ payeeName
â”œâ”€ paymentMethod          â”œâ”€ transactionId
â”œâ”€ paymentReference       â”œâ”€ paymentStatus
â””â”€ paymentStatus          â””â”€ caseInstanceId
```

**é—®é¢˜ï¼š**
- æ•°æ®å†—ä½™
- åŒæ­¥å›°éš¾
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´

### 3.3 çŠ¶æ€ç®¡ç†é—®é¢˜

#### åŸå› 4ï¼šç†èµ”çŠ¶æ€ä¸æµç¨‹çŠ¶æ€æ²¡æœ‰æ˜ å°„å…³ç³»

**ç†èµ”çŠ¶æ€ï¼š**`APPROVED`ã€`PAID`ã€`CLOSED`

**BPMNæµç¨‹çŠ¶æ€ï¼š**
- æµç¨‹å®ä¾‹çŠ¶æ€ï¼ˆActiveã€Suspendedã€Completedï¼‰
- å½“å‰æ´»åŠ¨èŠ‚ç‚¹ï¼ˆvalidatePaymentã€executePaymentã€confirmPaymentç­‰ï¼‰
- æµç¨‹å˜é‡ï¼ˆpaymentStatusã€validationResultç­‰ï¼‰

**é—®é¢˜ï¼š**
- æ²¡æœ‰å»ºç«‹æ˜ å°„å…³ç³»
- ç†èµ”çŠ¶æ€`PAID`å¯èƒ½æ˜¯ï¼š
  - ç†èµ”è¯¦æƒ…é¡µç›´æ¥æ”¯ä»˜çš„
  - BPMNæµç¨‹å®Œæˆçš„
  - æ— æ³•åŒºåˆ†

### 3.4 ç”¨æˆ·ä½“éªŒé—®é¢˜

#### åŸå› 5ï¼šç¼ºå°‘ç»Ÿä¸€çš„æ”¯ä»˜å…¥å£

**å½“å‰æƒ…å†µï¼š**
- ç†èµ”è¯¦æƒ…é¡µï¼šæœ‰æ”¯ä»˜æŒ‰é’®ï¼Œä½†ç»•è¿‡BPMNæµç¨‹
- ä»»åŠ¡åˆ—è¡¨ï¼šæœ‰æ”¯ä»˜ä»»åŠ¡ï¼Œä½†ä¸çŸ¥é“å“ªä¸ªæ˜¯å½“å‰ç†èµ”çš„

**ç†æƒ³æƒ…å†µï¼š**
- ç»Ÿä¸€çš„æ”¯ä»˜å…¥å£
- æ¸…æ™°çš„æ”¯ä»˜æµç¨‹
- å®æ—¶çš„æ”¯ä»˜è¿›åº¦

---

## å››ã€æ”¹è¿›æ–¹æ¡ˆè®¾è®¡

### 4.1 æ–¹æ¡ˆæ¦‚è¿°

**æ ¸å¿ƒç†å¿µï¼š**
1. ç§»é™¤ç†èµ”è¯¦æƒ…é¡µçš„ç›´æ¥æ”¯ä»˜åŠŸèƒ½
2. è®©BPMNæ”¯ä»˜æµç¨‹æˆä¸ºå”¯ä¸€çš„æ”¯ä»˜è·¯å¾„
3. åœ¨ç†èµ”è¯¦æƒ…é¡µé›†æˆBPMNå­æµç¨‹å¯è§†åŒ–
4. å»ºç«‹ç†èµ”çŠ¶æ€ä¸BPMNæµç¨‹çŠ¶æ€çš„æ˜ å°„å…³ç³»

### 4.2 æ–¹æ¡ˆ1ï¼šå®Œå…¨åŸºäºBPMNæµç¨‹ï¼ˆæ¨èï¼‰

#### 4.2.1 æµç¨‹è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç†èµ”è¯¦æƒ…é¡µ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€: APPROVED                                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  BPMNæ”¯ä»˜æµç¨‹å¯è§†åŒ–                               â”‚  â”‚
â”‚  â”‚  [æ”¯ä»˜æ ¡éªŒ] â†’ [æ‰§è¡Œæ”¯ä»˜] â†’ [æ”¯ä»˜ç¡®è®¤] â†’ [å®Œæˆ]    â”‚  â”‚
â”‚  â”‚     â†‘                                           â”‚  â”‚
â”‚  â”‚  [å½“å‰èŠ‚ç‚¹]                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ“ä½œæŒ‰é’®                                         â”‚  â”‚
â”‚  â”‚  [æŸ¥çœ‹è¯¦æƒ…] [æµç¨‹ç›‘æ§] [è·³è½¬åˆ°ä»»åŠ¡]              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
            ç‚¹å‡»"è·³è½¬åˆ°ä»»åŠ¡"
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡åˆ—è¡¨é¡µ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¾…åŠä»»åŠ¡: æ”¯ä»˜æ ¡éªŒ - ç†èµ”å·: CLM-2024-001               â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ”¯ä»˜æ ¡éªŒæ¨¡æ€æ¡†                                   â”‚  â”‚
â”‚  â”‚  æ”¯ä»˜é‡‘é¢: Â¥100,000                              â”‚  â”‚
â”‚  â”‚  æ”¶æ¬¾äºº: å¼ ä¸‰                                     â”‚  â”‚
â”‚  â”‚  å‚è€ƒå·: PAY-20241226-001                        â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  æ ¡éªŒç»“æœ: ( ) æ‰¹å‡†  ( ) æ‹’ç»                    â”‚  â”‚
â”‚  â”‚  å¤‡æ³¨: _________________                          â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚         [å–æ¶ˆ]  [æäº¤]                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 åç«¯æ”¹åŠ¨

**1. ç§»é™¤æˆ–åºŸå¼ƒç›´æ¥æ”¯ä»˜API**

```java
// CaseResource.java
// @PostMapping("/{id}/pay")
// public ResponseEntity<ClaimCaseDTO> payClaim(
//     @PathVariable String id,
//     @RequestBody PaymentRequestDTO paymentRequest) {
//     // åºŸå¼ƒæ­¤APIï¼Œæ”¹ä¸ºé€šè¿‡BPMNæµç¨‹å¤„ç†
// }
```

**2. ç¡®ä¿CMMNæ­£ç¡®å¯åŠ¨BPMNæµç¨‹**

```java
// CaseService.java
public void approveClaim(String claimId, String userId, ApproveRequestDTO request) {
    ClaimCase claim = claimRepository.findById(Long.parseLong(claimId))
        .orElseThrow(() -> new RuntimeException("Claim not found"));
    
    // æ›´æ–°ç†èµ”ä¿¡æ¯
    claim.setStatus(ClaimStatus.APPROVED);
    claim.setApprovedAmount(request.getApprovedAmount());
    claimRepository.save(claim);
    
    // è®¾ç½®CMMNå˜é‡ï¼Œç”¨äºå¯åŠ¨BPMNæµç¨‹
    Map<String, Object> variables = new HashMap<>();
    variables.put("amount", request.getApprovedAmount());
    variables.put("reference", generatePaymentReference(claim));
    variables.put("payeeName", claim.getClaimantName());
    variables.put("claimId", claim.getId().toString());
    variables.put("caseInstanceId", claim.getCaseInstanceId());
    variables.put("paymentOfficer", "payment-officer");
    variables.put("paymentManager", "payment-manager");
    
    // å®ŒæˆCMMNå®¡æ‰¹ä»»åŠ¡ï¼Œè§¦å‘Payment Stage
    // Payment Stageä¼šè‡ªåŠ¨å¯åŠ¨BPMNæ”¯ä»˜æµç¨‹
    cmmnRuntimeService.completeTask(claim.getCaseInstanceId(), "FinalClaimApproval", variables);
}
```

**3. æä¾›BPMNå­æµç¨‹çŠ¶æ€æŸ¥è¯¢API**

```java
// AdminCaseResource.java
@GetMapping("/case/{caseInstanceId}/payment-process")
public ResponseEntity<BpmnSubprocessVisualizationDTO> getPaymentProcessState(
    @PathVariable String caseInstanceId) {
    
    // è·å–æ”¯ä»˜æµç¨‹çš„æ‰§è¡ŒçŠ¶æ€
    ProcessInstanceInfo paymentProcess = 
        processRuntimeService.getProcessByCaseInstanceId(caseInstanceId);
    
    // è·å–æ´»åŠ¨èŠ‚ç‚¹
    List<ActivityStateDTO> activeNodes = 
        processRuntimeService.getActiveActivities(paymentProcess.getId());
    
    // è·å–æµç¨‹å˜é‡
    Map<String, Object> variables = 
        processRuntimeService.getProcessVariables(paymentProcess.getId());
    
    // æ„å»ºå¯è§†åŒ–DTO
    BpmnSubprocessVisualizationDTO dto = new BpmnSubprocessVisualizationDTO();
    dto.setProcessInstanceId(paymentProcess.getId());
    dto.setProcessDefinitionKey(paymentProcess.getProcessDefinitionKey());
    dto.setActiveNodes(activeNodes);
    dto.setVariables(variables);
    
    return ResponseEntity.ok(dto);
}
```

#### 4.2.3 å‰ç«¯æ”¹åŠ¨

**1. ä¿®æ”¹ç†èµ”è¯¦æƒ…é¡µï¼ˆClaimDetail.tsxï¼‰**

```typescript
// ç§»é™¤æ”¯ä»˜æŒ‰é’®
// {claim.status === 'APPROVED' && (
//   <Button type="primary" icon={<DollarOutlined />}>æ”¯ä»˜</Button>
// )}

// æ·»åŠ BPMNæµç¨‹å¯è§†åŒ–ç»„ä»¶
import { BpmnSubprocessVisualizer } from './admin/BpmnSubprocessVisualizer';

const [paymentProcessData, setPaymentProcessData] = useState(null);

useEffect(() => {
  if (claim.status === 'APPROVED' || claim.status === 'PAID') {
    loadPaymentProcessState();
  }
}, [claim]);

const loadPaymentProcessState = async () => {
  try {
    const response = await adminApi.getPaymentProcessState(claim.caseInstanceId);
    setPaymentProcessData(response.data);
  } catch (error) {
    console.error('Failed to load payment process state:', error);
  }
};

// åœ¨UIä¸­æ·»åŠ æ”¯ä»˜æµç¨‹å¯è§†åŒ–
<Tabs defaultActiveKey="basic">
  <TabPane tab="åŸºæœ¬ä¿¡æ¯" key="basic">
    {/* ... */}
  </TabPane>
  
  <TabPane tab="æ”¯ä»˜è¿›åº¦" key="payment">
    {paymentProcessData ? (
      <BpmnSubprocessVisualizer data={paymentProcessData} />
    ) : (
      <Card>
        <div>æ”¯ä»˜æµç¨‹å°šæœªå¯åŠ¨</div>
      </Card>
    )}
  </TabPane>
</Tabs>
```

**2. å¢å¼ºä»»åŠ¡åˆ—è¡¨é¡µï¼ˆTaskList.tsxï¼‰**

```typescript
// æ·»åŠ å…³è”ç†èµ”ä¿¡æ¯çš„æ˜¾ç¤º
const columns = [
  {
    title: 'ä»»åŠ¡åç§°',
    dataIndex: 'name',
    key: 'name',
    render: (text: string, record: FlowableTask) => (
      <div>
        <Button 
          type="link" 
          onClick={() => {
            if (record.caseInstanceId) {
              navigate(`/claims/${record.caseInstanceId}`);
            }
          }}
        >
          {text}
        </Button>
        {record.processVariables?.claimId && (
          <div style={{ fontSize: '12px', color: '#999' }}>
            å…³è”ç†èµ”: {record.processVariables.claimId}
          </div>
        )}
      </div>
    )
  },
  // ... å…¶ä»–åˆ—
];

// åœ¨æ”¯ä»˜ä»»åŠ¡æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
<Modal
  title={
    <span>
      <DollarOutlined /> æ”¯ä»˜æ ¡éªŒ
      {taskVariables.claimId && (
        <Tag style={{ marginLeft: 8 }}>
          ç†èµ”: {taskVariables.claimId}
        </Tag>
      )}
    </span>
  }
  visible={validationModalVisible}
  // ...
>
  {/* ... */}
</Modal>
```

#### 4.2.4 æ•°æ®æµè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·åœ¨ç†èµ”è¯¦æƒ…é¡µç‚¹å‡»"æ‰¹å‡†"                              â”‚
â”‚     - è¾“å…¥æ‰¹å‡†é‡‘é¢                                           â”‚
â”‚     - ç‚¹å‡»ç¡®è®¤                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åç«¯å¤„ç†ï¼ˆCaseService.approveClaimï¼‰                    â”‚
â”‚     - æ›´æ–°ç†èµ”çŠ¶æ€ä¸ºAPPROVED                                â”‚
â”‚     - è®¾ç½®æ”¯ä»˜ç›¸å…³å˜é‡                                       â”‚
â”‚       * amount: æ‰¹å‡†é‡‘é¢                                    â”‚
â”‚       * reference: æ”¯ä»˜å‚è€ƒå·                               â”‚
â”‚       * payeeName: æ”¶æ¬¾äºº                                   â”‚
â”‚       * claimId: ç†èµ”ID                                     â”‚
â”‚       * caseInstanceId: Caseå®ä¾‹ID                          â”‚
â”‚     - å®ŒæˆCMMNå®¡æ‰¹ä»»åŠ¡                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. CMMNè§¦å‘Payment Stage                                   â”‚
â”‚     - ProcessTask: taskProcessPayment                       â”‚
â”‚     - ä¼ é€’å˜é‡åˆ°BPMNæµç¨‹                                     â”‚
â”‚     - å¯åŠ¨BPMNæµç¨‹å®ä¾‹                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. BPMNæµç¨‹å¯åŠ¨                                             â”‚
â”‚     - åˆ›å»ºuserTask_validatePaymentä»»åŠ¡                      â”‚
â”‚     - åˆ†é…ç»™paymentOfficer                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. å‰ç«¯æ˜¾ç¤ºæ”¯ä»˜æµç¨‹å¯è§†åŒ–                                    â”‚
â”‚     - åœ¨ç†èµ”è¯¦æƒ…é¡µ"æ”¯ä»˜è¿›åº¦"æ ‡ç­¾é¡µæ˜¾ç¤ºæµç¨‹å›¾                 â”‚
â”‚     - é«˜äº®å½“å‰æ´»åŠ¨èŠ‚ç‚¹                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Payment Officeråœ¨ä»»åŠ¡åˆ—è¡¨å¤„ç†æ”¯ä»˜æ ¡éªŒ                    â”‚
â”‚     - ç‚¹å‡»"æ”¯ä»˜æ ¡éªŒ"ä»»åŠ¡                                     â”‚
â”‚     - æŸ¥çœ‹æ”¯ä»˜ä¿¡æ¯                                           â”‚
â”‚     - é€‰æ‹©"æ‰¹å‡†"æˆ–"æ‹’ç»"                                    â”‚
â”‚     - æäº¤ä»»åŠ¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. BPMNæµç¨‹ç»§ç»­                                             â”‚
â”‚     - å¦‚æœæ‰¹å‡†: è¿›å…¥serviceTask_executePayment               â”‚
â”‚     - å¦‚æœæ‹’ç»: è¿›å…¥userTask_paymentRejected                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. è‡ªåŠ¨æ‰§è¡Œæ”¯ä»˜                                             â”‚
â”‚     - PaymentService.execute()                              â”‚
â”‚     - ç”ŸæˆtransactionId                                     â”‚
â”‚     - è®¾ç½®paymentDateå’ŒpaymentStatus                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. åˆ›å»ºæ”¯ä»˜ç¡®è®¤ä»»åŠ¡                                          â”‚
â”‚     - userTask_confirmPayment                               â”‚
â”‚     - æ˜¾ç¤ºäº¤æ˜“ä¿¡æ¯                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. Payment Officerå¤„ç†æ”¯ä»˜ç¡®è®¤                              â”‚
â”‚      - æŸ¥çœ‹: transactionId, amount, payeeName, paymentDate   â”‚
â”‚      - é€‰æ‹©"ç¡®è®¤"æˆ–"äº‰è®®"                                    â”‚
â”‚      - æäº¤ä»»åŠ¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. æ›´æ–°ç†èµ”çŠ¶æ€                                             â”‚
â”‚      - serviceTask_updateCaseæ‰§è¡Œ                            â”‚
â”‚      - PaymentUpdateServiceæ›´æ–°ç†èµ”è¡¨                         â”‚
â”‚      - è®¾ç½®paidAmount, paymentDate, paymentMethodç­‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  12. å‘é€é€šçŸ¥                                                 â”‚
â”‚      - serviceTask_sendNotificationæ‰§è¡Œ                      â”‚
â”‚      - NotificationServiceå‘é€é‚®ä»¶/çŸ­ä¿¡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  13. æµç¨‹ç»“æŸ                                                 â”‚
â”‚      - BPMNæµç¨‹å®ä¾‹ç»“æŸ                                       â”‚
â”‚      - è§¦å‘Payment Completion Listener                        â”‚
â”‚      - CMMN Payment Stageå®Œæˆ                                â”‚
â”‚      - ç†èµ”çŠ¶æ€æ›´æ–°ä¸ºPAID                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ–¹æ¡ˆ2ï¼šä»»åŠ¡ä¸­å¿ƒä¸ç†èµ”è¯¦æƒ…åˆå¹¶ï¼ˆå¼ºçƒˆæ¨èï¼‰

#### 4.3.1 è®¾è®¡ç†å¿µ

**æ ¸å¿ƒæ€æƒ³ï¼š**
å°†ä»»åŠ¡å¤„ç†åŠŸèƒ½ç›´æ¥é›†æˆåˆ°ç†èµ”è¯¦æƒ…é¡µä¸­ï¼Œè®©ç†èµ”å‘˜åœ¨æŸ¥çœ‹ç†èµ”è¯¦æƒ…æ—¶å°±èƒ½å¤„ç†ç›¸å…³ä»»åŠ¡ï¼Œæ— éœ€åœ¨ä¸¤ä¸ªé¡µé¢ä¹‹é—´è·³è½¬ã€‚

**ä¼˜åŠ¿ï¼š**
1. **ä¸Šä¸‹æ–‡ä¿æŒ** - å¤„ç†ä»»åŠ¡æ—¶å§‹ç»ˆèƒ½çœ‹åˆ°å®Œæ•´çš„ç†èµ”ä¿¡æ¯
2. **å‡å°‘è·³è½¬** - é¿å…åœ¨ä»»åŠ¡åˆ—è¡¨å’Œç†èµ”è¯¦æƒ…ä¹‹é—´æ¥å›åˆ‡æ¢
3. **æå‡æ•ˆç‡** - ä¸€æ¬¡æ“ä½œå®Œæˆä»»åŠ¡å¤„ç†å’ŒçŠ¶æ€æ›´æ–°
4. **ç”¨æˆ·ä½“éªŒå¥½** - ç¬¦åˆ"æ‰€è§å³æ‰€å¾—"çš„è®¾è®¡åŸåˆ™

#### 4.3.2 ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç†èµ”è¯¦æƒ… - CLM-2024-001                                    [è¿”å›]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€: APPROVED  |  ä¸¥é‡ç¨‹åº¦: é«˜  |  åˆ†é…ç»™: å¼ ä¸‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¾…åŠä»»åŠ¡å¡ç‰‡                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ“‹ æ”¯ä»˜æ ¡éªŒ                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   ä»»åŠ¡ID: 123456                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   åˆ›å»ºæ—¶é—´: 2024-12-26 10:30:00                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   ä¼˜å…ˆçº§: é«˜                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   æ”¯ä»˜ä¿¡æ¯é¢„è§ˆ:                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - æ”¯ä»˜é‡‘é¢: Â¥100,000                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - æ”¶æ¬¾äºº: æå››                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - å‚è€ƒå·: PAY-20241226-001                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   [ç«‹å³å¤„ç†] [ç¨åå¤„ç†]                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ ‡ç­¾é¡µ                                                    â”‚ â”‚
â”‚  â”‚  [åŸºæœ¬ä¿¡æ¯] [æ”¯ä»˜è¿›åº¦] [ç›¸å…³æ–‡æ¡£] [å¤„ç†å†å²] [ä»»åŠ¡åˆ—è¡¨]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  åŸºæœ¬ä¿¡æ¯                                                 â”‚ â”‚
â”‚  â”‚  ç†èµ”é‡‘é¢: Â¥120,000                                       â”‚ â”‚
â”‚  â”‚  æ‰¹å‡†é‡‘é¢: Â¥100,000                                       â”‚ â”‚
â”‚  â”‚  ç”³è¯·äºº: æå››                                             â”‚ â”‚
â”‚  â”‚  äº‹æ•…æ—¶é—´: 2024-12-25 14:30:00                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‚¹å‡»"ç«‹å³å¤„ç†"åçš„ç•Œé¢ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç†èµ”è¯¦æƒ… - CLM-2024-001                                    [è¿”å›]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ’³ æ”¯ä»˜æ ¡éªŒä»»åŠ¡å¤„ç†                                     â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ æ”¯ä»˜ä¿¡æ¯                                             â”‚ â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚ æ”¯ä»˜é‡‘é¢:   Â¥100,000                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æ”¶æ¬¾äºº:     æå›› (èº«ä»½è¯: 110101199001011234)      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ é“¶è¡Œè´¦æˆ·:   å·¥å•†é“¶è¡Œ 6222 0210 0101 2345 678       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ å‚è€ƒå·:     PAY-20241226-001                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æ‰¹å‡†é‡‘é¢:   Â¥100,000                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ å…³è”ç†èµ”ä¿¡æ¯                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚ ç†èµ”å·:     CLM-2024-001                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ ç†èµ”ç±»å‹:   è½¦è¾†æŸå¤±                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ äº‹æ•…æè¿°:   2024å¹´12æœˆ25æ—¥14:30ï¼Œè½¦è¾†åœ¨è·¯å£å‘ç”Ÿ    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚             ç¢°æ’äº‹æ•…ï¼Œé€ æˆå‰ä¿é™©æ ã€å·¦å‰è½¦é—¨æŸå     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ äº‹æ•…åœ°ç‚¹:   åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·                    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ æ ¡éªŒç»“æœ *                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ âšª æ‰¹å‡†  âšª æ‹’ç»                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æ ¡éªŒå¤‡æ³¨:                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                                                 â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                                                 â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  [å–æ¶ˆ]  [æäº¤æ ¡éªŒç»“æœ]                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  [æŠ˜å è¯¦ç»†ä¿¡æ¯]                                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ”¯ä»˜è¿›åº¦ (BPMNæµç¨‹å¯è§†åŒ–)                               â”‚ â”‚
â”‚  â”‚  [æ”¯ä»˜æ ¡éªŒ]â†’[æ‰§è¡Œæ”¯ä»˜]â†’[æ”¯ä»˜ç¡®è®¤]â†’[æ›´æ–°Case]â†’[å‘é€é€šçŸ¥]  â”‚ â”‚
â”‚  â”‚     â†‘                                                    â”‚ â”‚
â”‚  â”‚   å½“å‰èŠ‚ç‚¹                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.3 å‰ç«¯å®ç°

**1. ä¿®æ”¹ç†èµ”è¯¦æƒ…é¡µï¼ˆClaimDetail.tsxï¼‰**

```typescript
const ClaimDetail: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  
  // åŸæœ‰çŠ¶æ€
  const [loading, setLoading] = useState(true);
  const [claim, setClaim] = useState<ClaimCase | null>(null);
  
  // æ–°å¢ï¼šä»»åŠ¡ç›¸å…³çŠ¶æ€
  const [tasks, setTasks] = useState<FlowableTask[]>([]);
  const [currentTask, setCurrentTask] = useState<FlowableTask | null>(null);
  const [taskProcessingVisible, setTaskProcessingVisible] = useState(false);
  const [taskVariables, setTaskVariables] = useState<Record<string, any>>({});

  // åŠ è½½ä¸å½“å‰ç†èµ”å…³è”çš„ä»»åŠ¡
  const loadRelatedTasks = useCallback(async () => {
    try {
      const response = await taskApi.getTasksByCaseInstanceId(claim?.caseInstanceId);
      // åªæ˜¾ç¤ºæœªå®Œæˆçš„ä»»åŠ¡
      const activeTasks = response.data.filter(t => 
        t.caseInstanceId === claim?.caseInstanceId && !t.endTime
      );
      setTasks(activeTasks);
      
      // å¦‚æœæœ‰å¾…åŠä»»åŠ¡ï¼Œè®¾ç½®ç¬¬ä¸€ä¸ªä¸ºå½“å‰ä»»åŠ¡
      if (activeTasks.length > 0) {
        setCurrentTask(activeTasks[0]);
      }
    } catch (error) {
      console.error('Failed to load related tasks:', error);
    }
  }, [claim?.caseInstanceId]);

  useEffect(() => {
    if (claim?.caseInstanceId) {
      loadRelatedTasks();
    }
  }, [claim?.caseInstanceId, loadRelatedTasks]);

  // å¤„ç†ä»»åŠ¡
  const handleProcessTask = async (task: FlowableTask) => {
    setCurrentTask(task);
    
    // åŠ è½½ä»»åŠ¡å˜é‡
    try {
      const response = await taskApi.getTaskVariables(task.id);
      setTaskVariables(response.data);
      setTaskProcessingVisible(true);
    } catch (error) {
      console.error('Failed to load task variables:', error);
      message.error('åŠ è½½ä»»åŠ¡ä¿¡æ¯å¤±è´¥');
    }
  };

  // æäº¤ä»»åŠ¡
  const handleSubmitTask = async (values: any) => {
    try {
      if (!currentTask) return;

      // æ ¹æ®ä»»åŠ¡ç±»å‹æäº¤
      switch (currentTask.taskDefinitionKey) {
        case 'userTask_validatePayment':
          await taskApi.completeTask(currentTask.id, {
            validationResult: values.validationResult,
            validationComment: values.validationComment
          });
          break;
        case 'userTask_confirmPayment':
          await taskApi.completeTask(currentTask.id, {
            confirmationResult: values.confirmationResult,
            confirmationComment: values.confirmationComment
          });
          break;
        // ... å…¶ä»–ä»»åŠ¡ç±»å‹
      }

      message.success('ä»»åŠ¡å¤„ç†æˆåŠŸ');
      setTaskProcessingVisible(false);
      
      // é‡æ–°åŠ è½½ä»»åŠ¡å’Œç†èµ”ä¿¡æ¯
      loadRelatedTasks();
      loadClaimDetail();
    } catch (error) {
      console.error('Failed to complete task:', error);
      message.error('ä»»åŠ¡å¤„ç†å¤±è´¥');
    }
  };

  return (
    <div>
      {/* é¡µé¢å¤´éƒ¨ */}
      <Card>
        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
          <div>
            <h2>ç†èµ”è¯¦æƒ… - {claim?.claimNumber}</h2>
            <Space>
              <Tag color={getStatusColor(claim?.status)}>
                {getStatusText(claim?.status)}
              </Tag>
              <Tag color={getSeverityColor(claim?.severity)}>
                {getSeverityText(claim?.severity)}
              </Tag>
            </Space>
          </div>
          <Button icon={<ArrowLeftOutlined />} onClick={() => navigate('/claims')}>
            è¿”å›
          </Button>
        </div>
      </Card>

      {/* å¾…åŠä»»åŠ¡å¡ç‰‡ */}
      {currentTask && (
        <Card 
          title="å¾…åŠä»»åŠ¡" 
          extra={
            <Tag color="processing">
              {tasks.length} ä¸ªä»»åŠ¡å¾…å¤„ç†
            </Tag>
          }
          style={{ marginTop: 16, marginBottom: 16, border: '2px solid #1890ff' }}
        >
          <List
            dataSource={tasks}
            renderItem={(task) => (
              <List.Item
                key={task.id}
                style={{
                  backgroundColor: task.id === currentTask?.id ? '#e6f7ff' : 'transparent',
                  padding: 16,
                  borderRadius: 8,
                  marginBottom: 8
                }}
              >
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: '16px', fontWeight: 'bold', marginBottom: 8 }}>
                    {task.name}
                  </div>
                  <div style={{ color: '#666', fontSize: '12px', marginBottom: 8 }}>
                    ä»»åŠ¡ID: {task.id} | åˆ›å»ºæ—¶é—´: {new Date(task.createTime).toLocaleString()}
                  </div>
                  
                  {/* æ˜¾ç¤ºä»»åŠ¡å…³é”®ä¿¡æ¯ */}
                  {task.taskDefinitionKey === 'userTask_validatePayment' && (
                    <Descriptions size="small" column={3}>
                      <Descriptions.Item label="æ”¯ä»˜é‡‘é¢">
                        Â¥{(taskVariables.amount || 0).toLocaleString()}
                      </Descriptions.Item>
                      <Descriptions.Item label="æ”¶æ¬¾äºº">
                        {taskVariables.payeeName}
                      </Descriptions.Item>
                      <Descriptions.Item label="å‚è€ƒå·">
                        {taskVariables.reference}
                      </Descriptions.Item>
                    </Descriptions>
                  )}
                  
                  <div style={{ marginTop: 8 }}>
                    <Button 
                      type="primary" 
                      onClick={() => handleProcessTask(task)}
                    >
                      ç«‹å³å¤„ç†
                    </Button>
                    {tasks.length > 1 && (
                      <Button 
                        style={{ marginLeft: 8 }}
                        onClick={() => setCurrentTask(task)}
                      >
                        ç¨åå¤„ç†
                      </Button>
                    )}
                  </div>
                </div>
              </List.Item>
            )}
          />
        </Card>
      )}

      {/* è¯¦æƒ…å†…å®¹ */}
      <Tabs defaultActiveKey="basic">
        <TabPane tab="åŸºæœ¬ä¿¡æ¯" key="basic">
          {/* ... åŸæœ‰çš„åŸºæœ¬ä¿¡æ¯å†…å®¹ ... */}
        </TabPane>
        
        <TabPane tab="æ”¯ä»˜è¿›åº¦" key="payment">
          {/* BPMNæµç¨‹å¯è§†åŒ– */}
          {paymentProcessData && (
            <BpmnSubprocessVisualizer data={paymentProcessData} />
          )}
        </TabPane>
        
        <TabPane tab="ä»»åŠ¡åˆ—è¡¨" key="tasks">
          <Table
            dataSource={tasks}
            columns={taskColumns}
            rowKey="id"
            pagination={false}
          />
        </TabPane>
        
        <TabPane tab="ç›¸å…³æ–‡æ¡£" key="documents">
          {/* ... åŸæœ‰çš„æ–‡æ¡£åˆ—è¡¨ ... */}
        </TabPane>
        
        <TabPane tab="å¤„ç†å†å²" key="history">
          {/* ... åŸæœ‰çš„å¤„ç†å†å² ... */}
        </TabPane>
      </Tabs>

      {/* ä»»åŠ¡å¤„ç†æ¨¡æ€æ¡† */}
      <Modal
        title={
          <span>
            {currentTask?.taskDefinitionKey === 'userTask_validatePayment' && (
              <><DollarOutlined /> æ”¯ä»˜æ ¡éªŒ</>
            )}
            {currentTask?.taskDefinitionKey === 'userTask_confirmPayment' && (
              <><DollarOutlined /> æ”¯ä»˜ç¡®è®¤</>
            )}
            {/* ... å…¶ä»–ä»»åŠ¡ç±»å‹ ... */}
          </span>
        }
        visible={taskProcessingVisible}
        onCancel={() => {
          setTaskProcessingVisible(false);
          form.resetFields();
        }}
        onOk={() => form.submit()}
        width={800}
      >
        {/* æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„å¤„ç†è¡¨å• */}
        {currentTask?.taskDefinitionKey === 'userTask_validatePayment' && (
          <div>
            <Card title="æ”¯ä»˜ä¿¡æ¯" size="small" style={{ marginBottom: 16 }}>
              <Descriptions bordered column={2}>
                <Descriptions.Item label="æ”¯ä»˜é‡‘é¢">
                  Â¥{(taskVariables.amount || 0).toLocaleString()}
                </Descriptions.Item>
                <Descriptions.Item label="æ”¶æ¬¾äºº">
                  {taskVariables.payeeName}
                </Descriptions.Item>
                <Descriptions.Item label="å‚è€ƒå·">
                  {taskVariables.reference}
                </Descriptions.Item>
                <Descriptions.Item label="æ‰¹å‡†é‡‘é¢">
                  Â¥{(claim?.approvedAmount || 0).toLocaleString()}
                </Descriptions.Item>
              </Descriptions>
            </Card>

            <Card title="å…³è”ç†èµ”ä¿¡æ¯" size="small" style={{ marginBottom: 16 }}>
              <Descriptions bordered column={1}>
                <Descriptions.Item label="ç†èµ”å·">{claim?.claimNumber}</Descriptions.Item>
                <Descriptions.Item label="ç†èµ”ç±»å‹">{claim?.claimType}</Descriptions.Item>
                <Descriptions.Item label="äº‹æ•…æè¿°">
                  {claim?.incidentDescription}
                </Descriptions.Item>
                <Descriptions.Item label="äº‹æ•…åœ°ç‚¹">{claim?.incidentLocation}</Descriptions.Item>
              </Descriptions>
            </Card>

            <Form form={form} onFinish={handleSubmitTask} layout="vertical">
              <Form.Item 
                name="validationResult" 
                label="æ ¡éªŒç»“æœ" 
                rules={[{ required: true, message: 'è¯·é€‰æ‹©æ ¡éªŒç»“æœ' }]}
              >
                <Radio.Group>
                  <Radio value="approved">æ‰¹å‡†</Radio>
                  <Radio value="rejected">æ‹’ç»</Radio>
                </Radio.Group>
              </Form.Item>
              <Form.Item name="validationComment" label="æ ¡éªŒå¤‡æ³¨">
                <TextArea rows={4} placeholder="è¯·è¾“å…¥æ ¡éªŒå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" />
              </Form.Item>
            </Form>
          </div>
        )}
        
        {/* ... å…¶ä»–ä»»åŠ¡ç±»å‹çš„è¡¨å• ... */}
      </Modal>
    </div>
  );
};
```

**2. æ·»åŠ æ–°çš„APIæ–¹æ³•**

```typescript
// frontend/src/services/api.ts
export const taskApi = {
  // ... ç°æœ‰æ–¹æ³• ...
  
  // æ ¹æ®Caseå®ä¾‹IDè·å–ç›¸å…³ä»»åŠ¡
  getTasksByCaseInstanceId: (caseInstanceId?: string) => 
    axios.get<PageResponse<FlowableTask>>(
      `/api/tasks/by-case/${caseInstanceId}`
    ),
  
  // è·å–ä»»åŠ¡å˜é‡
  getTaskVariables: (taskId: string) => 
    axios.get<Record<string, any>>(`/api/tasks/${taskId}/variables`),
};
```

**3. åç«¯æ·»åŠ æ–°API**

```java
// backend/src/main/java/com/flowable/demo/web/rest/TaskResource.java

@GetMapping("/by-case/{caseInstanceId}")
public ResponseEntity<Page<FlowableTaskDTO>> getTasksByCaseInstanceId(
    @PathVariable String caseInstanceId,
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "20") int size) {
    
    // æŸ¥è¯¢ä¸æŒ‡å®šCaseå®ä¾‹å…³è”çš„ä»»åŠ¡
    Page<FlowableTaskDTO> tasks = taskService.getTasksByCaseInstanceId(
        caseInstanceId, page, size);
    
    return ResponseEntity.ok(tasks);
}

@GetMapping("/{taskId}/variables")
public ResponseEntity<Map<String, Object>> getTaskVariables(
    @PathVariable String taskId) {
    
    Map<String, Object> variables = taskService.getTaskVariables(taskId);
    return ResponseEntity.ok(variables);
}
```

#### 4.3.4 æ•°æ®æµä¼˜åŒ–

**ä»»åŠ¡å¤„ç†æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·æ‰“å¼€ç†èµ”è¯¦æƒ…é¡µ                                       â”‚
â”‚     - URL: /claims/{id}                                     â”‚
â”‚     - åŠ è½½ç†èµ”åŸºæœ¬ä¿¡æ¯                                       â”‚
â”‚     - åŠ è½½ä¸è¯¥ç†èµ”å…³è”çš„ä»»åŠ¡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ˜¾ç¤ºå¾…åŠä»»åŠ¡å¡ç‰‡                                         â”‚
â”‚     - å¦‚æœæœ‰å¾…åŠä»»åŠ¡ï¼Œæ˜¾ç¤ºåœ¨é¡¶éƒ¨                               â”‚
â”‚     - é«˜äº®ç¬¬ä¸€ä¸ªå¾…åŠä»»åŠ¡                                     â”‚
â”‚     - æ˜¾ç¤ºä»»åŠ¡å…³é”®ä¿¡æ¯é¢„è§ˆ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç”¨æˆ·ç‚¹å‡»"ç«‹å³å¤„ç†"                                       â”‚
â”‚     - åŠ è½½ä»»åŠ¡çš„å®Œæ•´å˜é‡                                     â”‚
â”‚     - æ‰“å¼€ä»»åŠ¡å¤„ç†æ¨¡æ€æ¡†                                     â”‚
â”‚     - åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºï¼š                                        â”‚
â”‚       * ä»»åŠ¡ä¿¡æ¯                                            â”‚
â”‚       * æ”¯ä»˜ä¿¡æ¯ï¼ˆå¦‚é€‚ç”¨ï¼‰                                   â”‚
â”‚       * å…³è”ç†èµ”ä¿¡æ¯                                         â”‚
â”‚       * å¤„ç†è¡¨å•                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ç”¨æˆ·å¡«å†™è¡¨å•å¹¶æäº¤                                       â”‚
â”‚     - éªŒè¯è¡¨å•æ•°æ®                                           â”‚
â”‚     - è°ƒç”¨taskApi.completeTask()                            â”‚
â”‚     - ä¼ é€’ä»»åŠ¡å˜é‡                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. åç«¯å¤„ç†ä»»åŠ¡                                             â”‚
â”‚     - å®ŒæˆBPMNä»»åŠ¡                                          â”‚
â”‚     - æµç¨‹è‡ªåŠ¨æµè½¬åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹                                â”‚
â”‚     - å¦‚æœæ˜¯æ”¯ä»˜ç¡®è®¤ä»»åŠ¡ï¼Œåˆ›å»ºä¸‹ä¸€ä¸ªæ”¯ä»˜ç¡®è®¤ä»»åŠ¡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å‰ç«¯åˆ·æ–°æ•°æ®                                             â”‚
â”‚     - é‡æ–°åŠ è½½ä¸ç†èµ”å…³è”çš„ä»»åŠ¡                               â”‚
â”‚     - é‡æ–°åŠ è½½ç†èµ”ä¿¡æ¯                                       â”‚
â”‚     - é‡æ–°åŠ è½½BPMNæµç¨‹çŠ¶æ€                                   â”‚
â”‚     - å…³é—­ä»»åŠ¡å¤„ç†æ¨¡æ€æ¡†                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. æ›´æ–°ç•Œé¢                                                 â”‚
â”‚     - å¦‚æœæœ‰æ–°ä»»åŠ¡ï¼Œæ˜¾ç¤ºæ–°çš„å¾…åŠä»»åŠ¡å¡ç‰‡                       â”‚
â”‚     - æ›´æ–°æ”¯ä»˜è¿›åº¦å¯è§†åŒ–                                     â”‚
â”‚     - æ˜¾ç¤ºä»»åŠ¡å¤„ç†æˆåŠŸæç¤º                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.5 æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | æ–¹æ¡ˆ1ï¼šåˆ†ç¦»æ¨¡å¼ | æ–¹æ¡ˆ2ï¼šåˆå¹¶æ¨¡å¼ |
|------|----------------|----------------|
| é¡µé¢è·³è½¬ | éœ€è¦åœ¨ä»»åŠ¡åˆ—è¡¨å’Œç†èµ”è¯¦æƒ…ä¹‹é—´è·³è½¬ | æ— éœ€è·³è½¬ï¼Œåœ¨åŒä¸€é¡µé¢å¤„ç† |
| ä¸Šä¸‹æ–‡ | å¤„ç†ä»»åŠ¡æ—¶éœ€è¦æ‰“å¼€æ–°æ ‡ç­¾æˆ–è·³è½¬ | å§‹ç»ˆä¿æŒç†èµ”ä¸Šä¸‹æ–‡ |
| ç”¨æˆ·ä½“éªŒ | è¾ƒå·®ï¼Œéœ€è¦è®°å¿†å½“å‰ç†èµ” | ä¼˜ç§€ï¼Œä¿¡æ¯å®Œæ•´å¯è§ |
| å¼€å‘å¤æ‚åº¦ | è¾ƒä½ï¼Œç°æœ‰ç»“æ„æ”¹åŠ¨å° | ä¸­ç­‰ï¼Œéœ€è¦é‡æ„é¡µé¢ |
| ç»´æŠ¤æˆæœ¬ | è¾ƒä½ | ä¸­ç­‰ |
| æ‰©å±•æ€§ | è¾ƒå¥½ï¼Œä»»åŠ¡å’Œè¯¦æƒ…ç‹¬ç«‹ | è¾ƒå¥½ï¼Œç»„ä»¶åŒ–è®¾è®¡ |

#### 4.3.6 å®æ–½å»ºè®®

**æ¨èé‡‡ç”¨æ–¹æ¡ˆ2ï¼šä»»åŠ¡ä¸­å¿ƒä¸ç†èµ”è¯¦æƒ…åˆå¹¶**

**ç†ç”±ï¼š**
1. **ç”¨æˆ·ä½“éªŒæå‡æ˜¾è‘—** - å‡å°‘è·³è½¬ï¼Œæé«˜å·¥ä½œæ•ˆç‡
2. **ç¬¦åˆä¸šåŠ¡åœºæ™¯** - ç†èµ”å¤„ç†å‘˜éœ€è¦åŒæ—¶æŸ¥çœ‹ä»»åŠ¡å’Œç†èµ”è¯¦æƒ…
3. **æŠ€æœ¯å¯è¡Œæ€§é«˜** - å¯ä»¥å¤ç”¨ç°æœ‰ç»„ä»¶
4. **é•¿æœŸç»´æŠ¤æˆæœ¬ä½** - ç»Ÿä¸€çš„ç•Œé¢é€»è¾‘æ›´æ˜“ç»´æŠ¤

**å®æ–½æ­¥éª¤ï¼š**
1. ä¿ç•™ä»»åŠ¡åˆ—è¡¨é¡µï¼ˆç”¨äºæŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ï¼‰
2. é‡æ„ç†èµ”è¯¦æƒ…é¡µï¼Œé›†æˆä»»åŠ¡å¤„ç†åŠŸèƒ½
3. æ·»åŠ ä»»åŠ¡ä¸ç†èµ”å…³è”çš„æŸ¥è¯¢API
4. ä¼˜åŒ–ä»»åŠ¡å¤„ç†æ¨¡æ€æ¡†çš„UI/UX
5. æ·»åŠ å®æ—¶æ›´æ–°æœºåˆ¶ï¼ˆå¯é€‰ï¼‰

### 4.4 æ–¹æ¡ˆ3ï¼šæ··åˆæ¨¡å¼ï¼ˆä¸æ¨èï¼‰
### 4.4 æ–¹æ¡ˆ3ï¼šæ··åˆæ¨¡å¼ï¼ˆä¸æ¨èï¼‰

---

## äº”ã€å®æ–½å»ºè®®

### 5.1 å®æ–½æ­¥éª¤ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

**é€‰æ‹©æ–¹æ¡ˆï¼š** é‡‡ç”¨æ–¹æ¡ˆ2ï¼ˆä»»åŠ¡ä¸­å¿ƒä¸ç†èµ”è¯¦æƒ…åˆå¹¶ï¼‰

#### é˜¶æ®µ1ï¼šåç«¯æ”¹è¿›ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **ä¿®æ”¹å®¡æ‰¹é€»è¾‘**
   - ç¡®ä¿å®¡æ‰¹æ—¶è®¾ç½®æ‰€æœ‰å¿…éœ€çš„å˜é‡
   - æ­£ç¡®å®ŒæˆCMMNä»»åŠ¡ä»¥è§¦å‘Payment Stage
   - æµ‹è¯•BPMNæµç¨‹è‡ªåŠ¨å¯åŠ¨

2. **æ·»åŠ æ”¯ä»˜æµç¨‹çŠ¶æ€API**
   - å®ç°è·å–BPMNå­æµç¨‹çŠ¶æ€çš„æ¥å£
   - è¿”å›æ´»åŠ¨èŠ‚ç‚¹å’Œæµç¨‹å˜é‡
   - æ”¯æŒæµç¨‹å¯è§†åŒ–æ•°æ®

3. **æ”¹è¿›çŠ¶æ€åŒæ­¥**
   - åœ¨PaymentUpdateServiceä¸­æ­£ç¡®æ›´æ–°ç†èµ”çŠ¶æ€
   - ç¡®ä¿BPMNæµç¨‹å˜é‡ä¸ç†èµ”æ•°æ®åº“åŒæ­¥
   - æ·»åŠ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

#### é˜¶æ®µ2ï¼šå‰ç«¯æ”¹è¿›ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **é‡æ„ç†èµ”è¯¦æƒ…é¡µ - é›†æˆä»»åŠ¡å¤„ç†**
   - åœ¨ç†èµ”è¯¦æƒ…é¡µé¡¶éƒ¨æ·»åŠ å¾…åŠä»»åŠ¡å¡ç‰‡
   - å®ç°ä»»åŠ¡ä¸ç†èµ”çš„å…³è”æŸ¥è¯¢
   - åˆ›å»ºä»»åŠ¡å¤„ç†æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºå®Œæ•´ä¸Šä¸‹æ–‡
   - æ”¯æŒåœ¨ä»»åŠ¡å¡ç‰‡ä¸­ç›´æ¥å¤„ç†ä»»åŠ¡

2. **é›†æˆBPMNæµç¨‹å¯è§†åŒ–**
   - åœ¨ç†èµ”è¯¦æƒ…é¡µæ·»åŠ "æ”¯ä»˜è¿›åº¦"æ ‡ç­¾é¡µ
   - ä½¿ç”¨ç°æœ‰çš„BpmnSubprocessVisualizerç»„ä»¶
   - å®æ—¶æ›´æ–°æµç¨‹çŠ¶æ€

3. **ä¼˜åŒ–ä»»åŠ¡åˆ—è¡¨é¡µï¼ˆä¿ç•™ï¼‰**
   - æ˜¾ç¤ºå…³è”çš„ç†èµ”ä¿¡æ¯
   - æä¾›å¿«é€Ÿè·³è½¬åˆ°ç†èµ”è¯¦æƒ…çš„é“¾æ¥
   - ä»»åŠ¡åˆ—è¡¨ä½œä¸ºä»»åŠ¡æ€»è§ˆçš„å…¥å£

4. **ç§»é™¤ç›´æ¥æ”¯ä»˜åŠŸèƒ½**
   - åˆ é™¤æˆ–ç¦ç”¨ç†èµ”è¯¦æƒ…é¡µçš„æ—§"æ”¯ä»˜"æŒ‰é’®
   - æ”¯ä»˜åŠŸèƒ½å®Œå…¨é€šè¿‡ä»»åŠ¡å¤„ç†å®ç°

#### é˜¶æ®µ3ï¼šç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **æ·»åŠ æ”¯ä»˜è¿›åº¦æŒ‡ç¤ºå™¨**
   - åœ¨ç†èµ”è¯¦æƒ…é¡µæ˜¾ç¤ºè¿›åº¦æ¡
   - é«˜äº®å½“å‰æ”¯ä»˜é˜¶æ®µ
   - æ˜¾ç¤ºé¢„è®¡å®Œæˆæ—¶é—´

2. **æ”¹è¿›é€šçŸ¥æœºåˆ¶**
   - æ”¯ä»˜ä»»åŠ¡åˆ†é…æ—¶å‘é€é€šçŸ¥
   - æ”¯ä»˜å®Œæˆæ—¶å‘é€é€šçŸ¥
   - æ”¯ä»˜å¤±è´¥æ—¶å‘é€è­¦å‘Š

3. **æ·»åŠ æ“ä½œæ—¥å¿—**
   - è®°å½•æ‰€æœ‰æ”¯ä»˜ç›¸å…³æ“ä½œ
   - åœ¨ç†èµ”è¯¦æƒ…é¡µæ˜¾ç¤ºæ“ä½œå†å²
   - æ”¯æŒå®¡è®¡è¿½è¸ª

#### é˜¶æ®µ4ï¼šæµ‹è¯•å’Œæ–‡æ¡£ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - æµ‹è¯•å®Œæ•´çš„æ”¯ä»˜æµç¨‹
   - æµ‹è¯•å„ç§åˆ†æ”¯åœºæ™¯ï¼ˆæ‰¹å‡†ã€æ‹’ç»ã€äº‰è®®ï¼‰
   - æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç†

2. **æ›´æ–°æ–‡æ¡£**
   - æ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼Œè¯´æ˜æ–°çš„æ”¯ä»˜æµç¨‹
   - æ›´æ–°å¼€å‘æ–‡æ¡£ï¼Œè¯´æ˜æ¶æ„è®¾è®¡
   - æ·»åŠ APIæ–‡æ¡£

### 5.2 é£é™©è¯„ä¼°

#### é£é™©1ï¼šç°æœ‰æ•°æ®è¿ç§»

**é—®é¢˜æè¿°ï¼š**
- å¯èƒ½å­˜åœ¨å·²ç»é€šè¿‡ç›´æ¥æ”¯ä»˜APIå®Œæˆçš„ç†èµ”
- è¿™äº›ç†èµ”æ²¡æœ‰å¯¹åº”çš„BPMNæµç¨‹å®ä¾‹

**ç¼“è§£æªæ–½ï¼š**
- æ ‡è®°è¿™äº›ç†èµ”ä¸º"å†å²æ•°æ®"
- ç¦ç”¨å¯¹å®ƒä»¬çš„BPMNæµç¨‹å¯è§†åŒ–
- åœ¨æ–‡æ¡£ä¸­è¯´æ˜

#### é£é™©2ï¼šæƒé™é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- BPMNæµç¨‹ä¸­çš„ä»»åŠ¡åˆ†é…ç»™paymentOfficer
- éœ€è¦ç¡®ä¿æœ‰ç”¨æˆ·æ‹¥æœ‰æ­¤è§’è‰²

**ç¼“è§£æªæ–½ï¼š**
- åœ¨DataInitializerä¸­åˆ›å»ºpaymentOfficerè§’è‰²
- æ£€æŸ¥ç°æœ‰ç”¨æˆ·è§’è‰²é…ç½®
- æ·»åŠ è§’è‰²ç®¡ç†åŠŸèƒ½

#### é£é™©3ï¼šæ€§èƒ½é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- é¢‘ç¹æŸ¥è¯¢BPMNæµç¨‹çŠ¶æ€å¯èƒ½å½±å“æ€§èƒ½

**ç¼“è§£æªæ–½ï¼š**
- å®ç°ç¼“å­˜æœºåˆ¶
- ä½¿ç”¨WebSocketå®æ—¶æ›´æ–°
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 5.3 å›æ»šè®¡åˆ’

å¦‚æœå®æ–½è¿‡ç¨‹ä¸­å‡ºç°ä¸¥é‡é—®é¢˜ï¼š

1. **ä¿ç•™æ—§API**
   - æš‚æ—¶ä¿ç•™ç›´æ¥æ”¯ä»˜API
   - æ ‡è®°ä¸ºdeprecated

2. **å¿«é€Ÿå›æ»š**
   - æ¢å¤ç†èµ”è¯¦æƒ…é¡µçš„æ”¯ä»˜æŒ‰é’®
   - ç¦ç”¨BPMNæµç¨‹å¯è§†åŒ–
   - å›æ»šåç«¯æ”¹åŠ¨

3. **é—®é¢˜æ’æŸ¥**
   - åˆ†æé—®é¢˜åŸå› 
   - åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
   - é‡æ–°å®æ–½

---

## å…­ã€æ¶æ„è®¾è®¡ï¼šå®Œå…¨åŸºäºæµç¨‹é©±åŠ¨çš„çŠ¶æ€ç®¡ç†ï¼ˆæ ¸å¿ƒï¼‰

### 6.1 å½“å‰æ¶æ„é—®é¢˜

#### é—®é¢˜1ï¼šçŠ¶æ€å˜æ›´çš„åŒé‡å…¥å£

**ç°çŠ¶åˆ†æï¼š**

```typescript
// å‰ç«¯ - ClaimDetail.tsx
// æ–¹å¼1: é€šè¿‡ä»»åŠ¡å¤„ç†é—´æ¥å½±å“çŠ¶æ€
const handleCompleteTask = async (taskId: string) => {
  await taskApi.completeTask(taskId);
  // çŠ¶æ€ç”±BPMNæµç¨‹è‡ªåŠ¨æ›´æ–°
};

// æ–¹å¼2: ç›´æ¥è°ƒç”¨APIæ›´æ–°çŠ¶æ€
const handleUpdateStatus = async (status: string) => {
  await claimApi.updateClaimCaseStatus(id, status, description, userId);
  // ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„çŠ¶æ€
};
```

**åç«¯ç›´æ¥æ›´æ–°çŠ¶æ€çš„APIï¼š**

```java
// CaseResource.java

// 1. ç›´æ¥æ›´æ–°çŠ¶æ€API
@PostMapping("/{id}/status")
public ResponseEntity<ClaimCaseDTO> updateClaimCaseStatus(
    @PathVariable UUID id,
    @RequestParam String status,
    @RequestParam(required = false) String description,
    @RequestParam String userId) {
    ClaimCase result = caseService.updateClaimCaseStatus(id, status, description, UUID.fromString(userId));
    // ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œç»•è¿‡æµç¨‹å¼•æ“
}

// 2. æ‰¹å‡†ç†èµ”API
@PostMapping("/{id}/approve")
public ResponseEntity<ClaimCaseDTO> approveClaimCase(
    @PathVariable UUID id,
    @RequestParam String userId,
    @RequestBody ApproveRequestDTO approveRequestDTO) {
    ClaimCase result = caseService.approveClaimCase(id, userId, approveRequestDTO);
    // ç›´æ¥ä¿®æ”¹çŠ¶æ€ä¸ºAPPROVED
}

// 3. æ‹’ç»ç†èµ”API
@PostMapping("/{id}/reject")
public ResponseEntity<ClaimCaseDTO> rejectClaimCase(
    @PathVariable UUID id,
    @RequestBody RejectRequestDTO rejectRequestDTO) {
    ClaimCase result = caseService.rejectClaimCase(id, rejectRequestDTO.getReason());
    // ç›´æ¥ä¿®æ”¹çŠ¶æ€ä¸ºREJECTED
}

// 4. æ”¯ä»˜ç†èµ”APIï¼ˆéœ€è¦ç§»é™¤ï¼‰
@PostMapping("/{id}/pay")
public ResponseEntity<ClaimCaseDTO> payClaimCase(
    @PathVariable String id,
    @RequestBody PaymentRequestDTO paymentRequestDTO) {
    ClaimCase result = caseService.payClaimCase(...);
    // ç›´æ¥ä¿®æ”¹çŠ¶æ€ä¸ºPAIDï¼Œå®Œå…¨ç»•è¿‡BPMNæµç¨‹
}
```

**é—®é¢˜ï¼š**
- å‰ç«¯æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æ”¹å˜çŠ¶æ€ï¼šé€šè¿‡ä»»åŠ¡å¤„ç†æˆ–ç›´æ¥è°ƒç”¨API
- çŠ¶æ€å˜æ›´ä¸åœ¨æµç¨‹å¼•æ“çš„æ§åˆ¶ä¸‹ï¼Œå®¹æ˜“å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- æµç¨‹çŠ¶æ€å’Œæ•°æ®åº“çŠ¶æ€å¯èƒ½ä¸åŒæ­¥

#### é—®é¢˜2ï¼šç›‘å¬å™¨æœªæ­£ç¡®æ›´æ–°CaseçŠ¶æ€

**å½“å‰PaymentUpdateServiceå®ç°ï¼š**

```java
@Override
public void execute(DelegateExecution execution) {
    String caseInstanceId = (String) execution.getVariable("caseInstanceId");
    String paymentStatus = (String) execution.getVariable("paymentStatus");
    String transactionId = (String) execution.getVariable("transactionId");
    
    if (caseInstanceId != null) {
        claimCaseRepository.findByCaseInstanceId(caseInstanceId).ifPresentOrElse(
            claimCase -> {
                // âŒ åªæ›´æ–°äº†paymentStatusï¼Œæ²¡æœ‰æ›´æ–°ä¸»çŠ¶æ€status
                claimCase.setPaymentStatus(paymentStatus);
                if (transactionId != null) {
                    claimCase.setTransactionId(transactionId);
                }
                claimCaseRepository.save(claimCase);
            },
            () -> { /* ... */ }
        );
    }
}
```

**å½“å‰PaymentCompletionListenerå®ç°ï¼š**

```java
@Override
public void notify(DelegateExecution execution) {
    String caseInstanceId = (String) execution.getVariable("caseInstanceId");
    String paymentStatus = (String) execution.getVariable("paymentStatus");
    String transactionId = (String) execution.getVariable("transactionId");
    
    // âŒ å®Œå…¨æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®é™…æ›´æ–°CaseçŠ¶æ€
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ”¯ä»˜å®Œæˆåçš„å¤„ç†é€»è¾‘
    // ä¾‹å¦‚æ›´æ–°CMMNæ¡ˆä¾‹çŠ¶æ€ã€å‘é€é€šçŸ¥ç­‰
}
```

**é—®é¢˜ï¼š**
- BPMNæµç¨‹ç»“æŸæ—¶ï¼ŒCaseçš„ä¸»çŠ¶æ€ï¼ˆstatusï¼‰æ²¡æœ‰è¢«æ›´æ–°ä¸ºPAIDæˆ–REJECTED
- PaymentUpdateServiceåªæ›´æ–°äº†è¾…åŠ©å­—æ®µï¼ˆpaymentStatusã€transactionIdï¼‰
- æµç¨‹å¼•æ“æ— æ³•æ§åˆ¶Caseçš„ç”Ÿå‘½å‘¨æœŸ

#### é—®é¢˜3ï¼šæµç¨‹çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€çš„æ˜ å°„ç¼ºå¤±

**CMMNæµç¨‹çŠ¶æ€ï¼š**
- Activeï¼ˆè¿›è¡Œä¸­ï¼‰
- Suspendedï¼ˆæš‚åœï¼‰
- Completedï¼ˆå®Œæˆï¼‰
- Terminatedï¼ˆç»ˆæ­¢ï¼‰

**BPMNæµç¨‹çŠ¶æ€ï¼š**
- æ”¯ä»˜æ ¡éªŒä¸­
- æ‰§è¡Œæ”¯ä»˜ä¸­
- æ”¯ä»˜ç¡®è®¤ä¸­
- æ”¯ä»˜è¢«æ‹’ç»
- å¤„ç†äº‰è®®ä¸­

**Caseæ•°æ®åº“çŠ¶æ€ï¼š**
```java
public enum ClaimStatus {
    SUBMITTED,      // å·²æäº¤
    UNDER_REVIEW,   // å®¡æ ¸ä¸­
    APPROVED,       // å·²æ‰¹å‡†
    PAID,           // å·²æ”¯ä»˜
    REJECTED,       // å·²æ‹’ç»
    CLOSED          // å·²å…³é—­
}
```

**é—®é¢˜ï¼š**
- æ²¡æœ‰å»ºç«‹æ¸…æ™°çš„æ˜ å°„å…³ç³»
- æµç¨‹çŠ¶æ€çš„æ”¹å˜ä¸ä¼šè‡ªåŠ¨è§¦å‘æ•°æ®åº“çŠ¶æ€çš„æ›´æ–°

### 6.2 æ¨èæ¶æ„ï¼šå®Œå…¨åŸºäºæµç¨‹é©±åŠ¨

#### 6.2.1 æ ¸å¿ƒåŸåˆ™

1. **å•ä¸€çœŸç›¸æ¥æºï¼ˆSingle Source of Truthï¼‰**
   - æµç¨‹å¼•æ“ï¼ˆCMMN + BPMNï¼‰æ˜¯CaseçŠ¶æ€çš„å†³å®šè€…
   - æ•°æ®åº“ä¸­çš„CaseçŠ¶æ€åªèƒ½ç”±æµç¨‹ç›‘å¬å™¨æ›´æ–°
   - ä»»ä½•å…¶ä»–æ–¹å¼ä¿®æ”¹çŠ¶æ€éƒ½æ˜¯éæ³•çš„

2. **å•å‘æ•°æ®æµ**
   ```
   ç”¨æˆ·æ“ä½œ â†’ å®Œæˆä»»åŠ¡ â†’ æµç¨‹æµè½¬ â†’ ç›‘å¬å™¨è§¦å‘ â†’ æ›´æ–°æ•°æ®åº“
   ```
   - ç”¨æˆ·åªèƒ½å®Œæˆä»»åŠ¡ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹çŠ¶æ€
   - çŠ¶æ€å˜æ›´ç”±æµç¨‹å¼•æ“æ§åˆ¶
   - æ•°æ®åº“æ˜¯çŠ¶æ€çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œæ˜¯æµç¨‹çŠ¶æ€çš„"æŠ•å½±"

3. **äº‹ä»¶é©±åŠ¨çŠ¶æ€åŒæ­¥**
   - åœ¨å…³é”®æµç¨‹èŠ‚ç‚¹æ·»åŠ ç›‘å¬å™¨
   - ç›‘å¬å™¨è´Ÿè´£å°†æµç¨‹çŠ¶æ€åŒæ­¥åˆ°æ•°æ®åº“
   - ä½¿ç”¨Flowableçš„äº‹ä»¶æœºåˆ¶ï¼Œä¸æ‰‹åŠ¨è°ƒç”¨æ›´æ–°API

#### 6.2.2 æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ ç†èµ”è¯¦æƒ…é¡µ   â”‚         â”‚  ä»»åŠ¡åˆ—è¡¨é¡µ   â”‚                    â”‚
â”‚  â”‚              â”‚         â”‚              â”‚                    â”‚
â”‚  â”‚ - åªè¯»æ˜¾ç¤º   â”‚         â”‚ - æ˜¾ç¤ºä»»åŠ¡   â”‚                    â”‚
â”‚  â”‚ - çŠ¶æ€å±•ç¤º   â”‚         â”‚ - å®Œæˆä»»åŠ¡   â”‚                    â”‚
â”‚  â”‚ - æµç¨‹å¯è§†åŒ– â”‚         â”‚ - ä¸ç›´æ¥ä¿®   â”‚                    â”‚
â”‚  â”‚              â”‚         â”‚   æ”¹çŠ¶æ€     â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                        â”‚                             â”‚
â”‚         â”‚ è¯»å–çŠ¶æ€               â”‚ å®Œæˆä»»åŠ¡                      â”‚
â”‚         â†“                        â†“                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â†“                        â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        APIå±‚                             â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  GET  /api/cases/{id}             - è·å–Caseè¯¦æƒ…         â”‚ â”‚
â”‚  â”‚  POST /api/tasks/{id}/complete    - å®Œæˆä»»åŠ¡ï¼ˆä¸ä¿®æ”¹çŠ¶æ€ï¼‰â”‚ â”‚
â”‚  â”‚  GET  /api/tasks/{id}/variables   - è·å–ä»»åŠ¡å˜é‡         â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  âŒ åºŸå¼ƒä»¥ä¸‹APIï¼š                                        â”‚ â”‚
â”‚  â”‚  POST /api/cases/{id}/status      - ç›´æ¥æ›´æ–°çŠ¶æ€         â”‚ â”‚
â”‚  â”‚  POST /api/cases/{id}/approve     - ç›´æ¥æ‰¹å‡†            â”‚ â”‚
â”‚  â”‚  POST /api/cases/{id}/reject      - ç›´æ¥æ‹’ç»            â”‚ â”‚
â”‚  â”‚  POST /api/cases/{id}/pay         - ç›´æ¥æ”¯ä»˜            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµç¨‹å¼•æ“å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   CMMNå¼•æ“       â”‚      â”‚   BPMNå¼•æ“       â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ Case Instance    â”‚â”€â”€â”€â†’  â”‚ Process Instance â”‚            â”‚
â”‚  â”‚                  â”‚      â”‚                  â”‚            â”‚
â”‚  â”‚ - Case Stage     â”‚      â”‚ - User Tasks     â”‚            â”‚
â”‚  â”‚ - Process Tasks  â”‚      â”‚ - Service Tasks  â”‚            â”‚
â”‚  â”‚ - Event Listenersâ”‚      â”‚ - Event Listenersâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                          â”‚                      â”‚
â”‚           â”‚ è§¦å‘ç›‘å¬å™¨                â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ç›‘å¬å™¨å±‚ï¼ˆçŠ¶æ€åŒæ­¥ï¼‰                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  CMMNèŠ‚ç‚¹ç›‘å¬å™¨:                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ SubmissionStage.start   â†’ SUBMITTED              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ReviewStage.start      â†’ UNDER_REVIEW           â”‚  â”‚
â”‚  â”‚  â”œâ”€ ApprovalStage.complete  â†’ APPROVED/REJECTED      â”‚  â”‚
â”‚  â”‚  â”œâ”€ PaymentStage.start     â†’ PAYMENT_IN_PROGRESS    â”‚  â”‚
â”‚  â”‚  â”œâ”€ ClosureStage.start     â†’ PAID/REJECTED           â”‚  â”‚
â”‚  â”‚  â””â”€ Case.complete         â†’ CLOSED                  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  BPMNèŠ‚ç‚¹ç›‘å¬å™¨:                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ start                  â†’ PAYMENT_IN_PROGRESS     â”‚  â”‚
â”‚  â”‚  â”œâ”€ executePayment         â†’ PAYING                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ confirmPayment         â†’ PAID                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ paymentRejected        â†’ PAYMENT_FAILED          â”‚  â”‚
â”‚  â”‚  â””â”€ end                    â†’ è§¦å‘Closure Stage       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åº“å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ClaimCaseè¡¨:                                              â”‚
â”‚  â”œâ”€ id (UUID)                                              â”‚
â”‚  â”œâ”€ caseInstanceId (String)  â† æµç¨‹å®ä¾‹ID                   â”‚
â”‚  â”œâ”€ status (ClaimStatus)      â† åªç”±ç›‘å¬å™¨æ›´æ–°             â”‚
â”‚  â”œâ”€ paymentStatus (String)    â† åªç”±ç›‘å¬å™¨æ›´æ–°             â”‚
â”‚  â”œâ”€ approvedAmount            â† åªç”±ç›‘å¬å™¨æ›´æ–°             â”‚
â”‚  â””â”€ ...å…¶ä»–åªè¯»æˆ–ç›‘å¬å™¨æ›´æ–°çš„å­—æ®µ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.2.3 çŠ¶æ€æ˜ å°„å…³ç³»

**CMMN CaseçŠ¶æ€ â†’ ClaimCaseæ•°æ®åº“çŠ¶æ€ï¼š**

| CMMNäº‹ä»¶ | å½“å‰CaseçŠ¶æ€ | ç›®æ ‡ClaimStatus | è¯´æ˜ |
|---------|-------------|----------------|------|
| SubmissionStageå¼€å§‹ | - | SUBMITTED | ç†èµ”æäº¤ |
| ReviewStageå¼€å§‹ | SUBMITTED | UNDER_REVIEW | è¿›å…¥å®¡æ ¸ |
| ApprovalTaskå®Œæˆï¼ˆapproved=trueï¼‰ | UNDER_REVIEW | APPROVED | å®¡æ‰¹é€šè¿‡ |
| ApprovalTaskå®Œæˆï¼ˆapproved=falseï¼‰ | UNDER_REVIEW | REJECTED | å®¡æ‰¹æ‹’ç» |
| PaymentStageå¼€å§‹ | APPROVED | PAYMENT_IN_PROGRESS | è¿›å…¥æ”¯ä»˜ |
| ClosureStageå®Œæˆ | PAID | CLOSED | æ”¯ä»˜æˆåŠŸåå…³é—­ |
| ClosureStageå®Œæˆ | REJECTED | CLOSED | æ‹’ç»åå…³é—­ |

**BPMNæ”¯ä»˜æµç¨‹çŠ¶æ€ â†’ ClaimCaseæ”¯ä»˜ç›¸å…³å­—æ®µï¼š**

| BPMNäº‹ä»¶ | å½“å‰çŠ¶æ€ | æ›´æ–°å­—æ®µ | è¯´æ˜ |
|---------|---------|---------|------|
| æµç¨‹å¼€å§‹ | APPROVED | paymentStatus=PAYMENT_IN_PROGRESS | å¼€å§‹æ”¯ä»˜æµç¨‹ |
| executePaymentå®Œæˆ | - | paymentStatus=PAYING, transactionId=xxx | æ‰§è¡Œæ”¯ä»˜ |
| confirmPaymentå®Œæˆï¼ˆç¡®è®¤ï¼‰ | - | paymentStatus=PAID, paidAmount=xxx, paymentDate=xxx | æ”¯ä»˜ç¡®è®¤ |
| confirmPaymentå®Œæˆï¼ˆäº‰è®®ï¼‰ | - | paymentStatus=DISPUTED | æ”¯ä»˜äº‰è®® |
| paymentRejectedè¿›å…¥ | - | paymentStatus=REJECTED | æ”¯ä»˜è¢«æ‹’ |
| æµç¨‹ç»“æŸï¼ˆæˆåŠŸï¼‰ | PAID | è§¦å‘CMMN Closure Stage | å…³é—­Case |

### 6.3 å®æ–½æ–¹æ¡ˆ

#### 6.3.1 åç«¯æ”¹è¿›

**1. æ‰©å±•PaymentUpdateService**

```java
@Service("paymentUpdateService")
@Slf4j
@RequiredArgsConstructor
public class PaymentUpdateService implements JavaDelegate {

    private final ClaimCaseRepository claimCaseRepository;

    @Override
    public void execute(DelegateExecution execution) {
        log.info("Payment update service triggered");
        
        String caseInstanceId = (String) execution.getVariable("caseInstanceId");
        String paymentStatus = (String) execution.getVariable("paymentStatus");
        String transactionId = (String) execution.getVariable("transactionId");
        String currentActivityId = execution.getCurrentActivityId();
        
        if (caseInstanceId == null) {
            log.warn("Case instance ID is null");
            return;
        }

        claimCaseRepository.findByCaseInstanceId(caseInstanceId).ifPresent(claimCase -> {
            // æ ¹æ®å½“å‰æ´»åŠ¨æ›´æ–°çŠ¶æ€
            updateClaimStatusByActivity(claimCase, currentActivityId, execution);
            
            // æ›´æ–°æ”¯ä»˜ç›¸å…³å­—æ®µ
            claimCase.setPaymentStatus(paymentStatus);
            if (transactionId != null) {
                claimCase.setTransactionId(transactionId);
            }
            
            // æ ¹æ®æ”¯ä»˜çŠ¶æ€æ›´æ–°ä¸»çŠ¶æ€
            updateMainStatusByPaymentStatus(claimCase, paymentStatus);
            
            claimCaseRepository.save(claimCase);
            log.info("Claim {} updated: paymentStatus={}, mainStatus={}", 
                claimCase.getId(), paymentStatus, claimCase.getStatus());
        });
    }

    private void updateClaimStatusByActivity(ClaimCase claimCase, String activityId, 
            DelegateExecution execution) {
        switch (activityId) {
            case "startEvent_paymentStart":
                // æ”¯ä»˜æµç¨‹å¼€å§‹ï¼Œæ›´æ–°ä¸ºæ”¯ä»˜è¿›è¡Œä¸­
                claimCase.setPaymentStatus("PAYMENT_IN_PROGRESS");
                break;
                
            case "serviceTask_executePayment":
                // æ‰§è¡Œæ”¯ä»˜
                claimCase.setPaymentStatus("PAYING");
                break;
                
            case "userTask_confirmPayment":
                // ç­‰å¾…ç¡®è®¤
                claimCase.setPaymentStatus("AWAITING_CONFIRMATION");
                break;
                
            case "userTask_paymentRejected":
                // æ”¯ä»˜è¢«æ‹’ç»
                claimCase.setPaymentStatus("PAYMENT_REJECTED");
                claimCase.setStatus(ClaimStatus.REJECTED);
                break;
                
            default:
                // å…¶ä»–èŠ‚ç‚¹ä¿æŒä¸å˜
                break;
        }
    }

    private void updateMainStatusByPaymentStatus(ClaimCase claimCase, String paymentStatus) {
        if ("PAID".equals(paymentStatus)) {
            // æ”¯ä»˜æˆåŠŸï¼Œç­‰å¾…Closure Stageå®Œæˆ
            claimCase.setStatus(ClaimStatus.PAID);
            claimCase.setPaidAmount(claimCase.getApprovedAmount());
            claimCase.setPaymentDate(java.time.LocalDate.now());
        } else if ("REJECTED".equals(paymentStatus) || "PAYMENT_REJECTED".equals(paymentStatus)) {
            // æ”¯ä»˜è¢«æ‹’ç»
            claimCase.setStatus(ClaimStatus.REJECTED);
        }
    }
}
```

**2. å®Œå–„PaymentCompletionListener**

```java
@Component("paymentCompletionListener")
@Slf4j
public class PaymentCompletionListener implements ExecutionListener {

    private final ClaimCaseRepository claimCaseRepository;
    private final CmmnRuntimeService cmmnRuntimeService;

    @Override
    public void notify(DelegateExecution execution) {
        log.info("Payment completion listener triggered");
        
        String caseInstanceId = (String) execution.getVariable("caseInstanceId");
        String paymentStatus = (String) execution.getVariable("paymentStatus");
        
        if (caseInstanceId == null) {
            log.warn("Case instance ID is null");
            return;
        }

        // æ›´æ–°CaseçŠ¶æ€
        claimCaseRepository.findByCaseInstanceId(caseInstanceId).ifPresent(claimCase -> {
            if ("PAID".equals(paymentStatus)) {
                // æ”¯ä»˜æˆåŠŸï¼Œè§¦å‘CMMN Closure Stage
                claimCase.setStatus(ClaimStatus.PAID);
                
                // æ‰‹åŠ¨è§¦å‘CMMN Stageå®Œæˆ
                triggerClosureStage(caseCase.getCaseInstanceId());
                
                log.info("Payment completed successfully for case {}", caseInstanceId);
            } else if ("REJECTED".equals(paymentStatus)) {
                // æ”¯ä»˜è¢«æ‹’ç»
                claimCase.setStatus(ClaimStatus.REJECTED);
                
                // è§¦å‘CMMN Closure Stageï¼ˆæ‹’ç»åˆ†æ”¯ï¼‰
                triggerClosureStage(claimCase.getCaseInstanceId());
                
                log.info("Payment rejected for case {}", caseInstanceId);
            }
            
            claimCaseRepository.save(claimCase);
        });
    }

    private void triggerClosureStage(String caseInstanceId) {
        // æ‰‹åŠ¨è§¦å‘Closure Stageçš„è¿›å…¥æ¡ä»¶
        // è¿™å¯èƒ½éœ€è¦é‡æ–°è®¾è®¡CMMNæ¨¡å‹ï¼Œæ·»åŠ ä¸€ä¸ªSentryç”¨äºPaymentå®Œæˆ
        cmmnRuntimeService.setVariable(caseInstanceId, "paymentCompleted", true);
        
        // æˆ–è€…ç›´æ¥è§¦å‘Closure Stage
        // cmmnRuntimeService.startPlanItem(caseInstanceId, "planItemClosure");
    }
}
```

**3. åˆ›å»ºCMMNé˜¶æ®µç›‘å¬å™¨**

```java
@Component("cmmnStageListener")
@Slf4j
public class CmmnStageListener implements CaseExecutionListener {

    private final ClaimCaseRepository claimCaseRepository;

    @Override
    public void notify(DelegateCaseExecution caseExecution) {
        String caseInstanceId = caseExecution.getId();
        String planItemId = caseExecution.getCurrentPlanItem();
        String eventName = caseExecution.getEventName();
        
        log.info("CMMN Stage listener: caseInstanceId={}, planItemId={}, event={}", 
            caseInstanceId, planItemId, eventName);
        
        claimCaseRepository.findByCaseInstanceId(caseInstanceId).ifPresent(claimCase -> {
            
            // æ ¹æ®Stageæ›´æ–°çŠ¶æ€
            if ("start".equals(eventName)) {
                updateStatusOnStageStart(claimCase, planItemId);
            } else if ("complete".equals(eventName)) {
                updateStatusOnStageComplete(claimCase, planItemId, caseExecution);
            }
            
            claimCaseRepository.save(claimCase);
        });
    }

    private void updateStatusOnStageStart(ClaimCase claimCase, String planItemId) {
        switch (planItemId) {
            case "planItemSubmission":
                claimCase.setStatus(ClaimStatus.SUBMITTED);
                break;
            case "planItemReview":
                claimCase.setStatus(ClaimStatus.UNDER_REVIEW);
                break;
            case "planItemPayment":
                claimCase.setPaymentStatus("PAYMENT_IN_PROGRESS");
                break;
            case "planItemClosure":
                // Closure Stageå¼€å§‹æ—¶ï¼ŒçŠ¶æ€åº”è¯¥å·²ç»æ˜¯PAIDæˆ–REJECTED
                // è¿™é‡Œä¸éœ€è¦æ”¹å˜
                break;
        }
    }

    private void updateStatusOnStageComplete(ClaimCase claimCase, String planItemId, 
            DelegateCaseExecution caseExecution) {
        switch (planItemId) {
            case "planItemSubmission":
                // Submissionå®Œæˆï¼Œè¿›å…¥Review
                break;
            case "planItemReview":
                // Reviewå®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦è¢«æ‰¹å‡†
                Boolean approved = (Boolean) caseExecution.getVariable("approved");
                if (approved != null && approved) {
                    claimCase.setStatus(ClaimStatus.APPROVED);
                    // è®¾ç½®æ‰¹å‡†é‡‘é¢
                    Object approvedAmount = caseExecution.getVariable("approvedAmount");
                    if (approvedAmount != null) {
                        claimCase.setApprovedAmount(new java.math.BigDecimal(approvedAmount.toString()));
                    }
                } else {
                    claimCase.setStatus(ClaimStatus.REJECTED);
                }
                break;
            case "planItemPayment":
                // Paymentå®Œæˆï¼ŒçŠ¶æ€ç”±PaymentCompletionListenerå¤„ç†
                break;
            case "planItemClosure":
                // Caseå®Œæˆï¼Œå…³é—­
                claimCase.setStatus(ClaimStatus.CLOSED);
                break;
        }
    }
}
```

**4. åœ¨CMMNæ¨¡å‹ä¸­æ³¨å†Œç›‘å¬å™¨**

```xml
<!-- ClaimCase.cmmn -->
<flowable:case id="ClaimCase" name="Claim Case" flowable:initiator="initiator">
    
    <!-- Submission Stage -->
    <cmmn:planItem id="planItemSubmission" name="Submission Stage">
        <cmmn:extensionElements>
            <flowable:taskListener event="start" delegateExpression="${cmmnStageListener}" />
            <flowable:taskListener event="complete" delegateExpression="${cmmnStageListener}" />
        </cmmn:extensionElements>
    </cmmn:planItem>
    
    <!-- Review Stage -->
    <cmmn:planItem id="planItemReview" name="Review Stage">
        <cmmn:extensionElements>
            <flowable:taskListener event="start" delegateExpression="${cmmnStageListener}" />
            <flowable:taskListener event="complete" delegateExpression="${cmmnStageListener}" />
        </cmmn:extensionElements>
    </cmmn:planItem>
    
    <!-- Payment Stage -->
    <cmmn:planItem id="planItemPayment" name="Payment Stage">
        <cmmn:extensionElements>
            <flowable:taskListener event="start" delegateExpression="${cmmnStageListener}" />
            <flowable:taskListener event="complete" delegateExpression="${cmmnStageListener}" />
        </cmmn:extensionElements>
    </cmmn:planItem>
    
    <!-- Closure Stage -->
    <cmmn:planItem id="planItemClosure" name="Closure Stage">
        <cmmn:extensionElements>
            <flowable:taskListener event="start" delegateExpression="${cmmnStageListener}" />
            <flowable:taskListener event="complete" delegateExpression="${cmmnStageListener}" />
        </cmmn:extensionElements>
    </cmmn:planItem>
    
</flowable:case>
```

**5. åºŸå¼ƒç›´æ¥æ›´æ–°çŠ¶æ€çš„API**

```java
// CaseResource.java

/**
 * @deprecated ä½¿ç”¨ä»»åŠ¡å¤„ç†æ–¹å¼ï¼Œä¸è¦ç›´æ¥æ›´æ–°çŠ¶æ€
 *             çŠ¶æ€å˜æ›´ç”±æµç¨‹ç›‘å¬å™¨è‡ªåŠ¨å¤„ç†
 */
@Deprecated(since = "1.0", forRemoval = true)
@PostMapping("/{id}/status")
@Operation(
    summary = "æ›´æ–°ç†èµ”çŠ¶æ€ï¼ˆå·²åºŸå¼ƒï¼‰", 
    description = "ã€å·²åºŸå¼ƒã€‘è¯·ä½¿ç”¨ä»»åŠ¡å¤„ç†æ–¹å¼ã€‚çŠ¶æ€å˜æ›´ç”±æµç¨‹ç›‘å¬å™¨è‡ªåŠ¨å¤„ç†ã€‚"
)
public ResponseEntity<ClaimCaseDTO> updateClaimCaseStatus(...) {
    log.warn("Direct status update is deprecated. Please use task completion.");
    throw new UnsupportedOperationException("Direct status update is deprecated");
}

/**
 * @deprecated å®¡æ‰¹é€šè¿‡é€šè¿‡å®Œæˆå®¡æ‰¹ä»»åŠ¡å®ç°
 */
@Deprecated
@PostMapping("/{id}/approve")
@Operation(
    summary = "æ‰¹å‡†ç†èµ”æ¡ˆä»¶ï¼ˆå·²åºŸå¼ƒï¼‰", 
    description = "ã€å·²åºŸå¼ƒã€‘è¯·å®Œæˆå®¡æ‰¹ä»»åŠ¡"
)
public ResponseEntity<ClaimCaseDTO> approveClaimCase(...) {
    log.warn("Direct approve is deprecated. Please complete the approval task.");
    throw new UnsupportedOperationException("Direct approve is deprecated");
}

/**
 * @deprecated æ‹’ç»é€šè¿‡å®Œæˆå®¡æ‰¹ä»»åŠ¡å®ç°
 */
@Deprecated
@PostMapping("/{id}/reject")
@Operation(
    summary = "æ‹’ç»ç†èµ”æ¡ˆä»¶ï¼ˆå·²åºŸå¼ƒï¼‰", 
    description = "ã€å·²åºŸå¼ƒã€‘è¯·å®Œæˆå®¡æ‰¹ä»»åŠ¡å¹¶è®¾ç½®approved=false"
)
public ResponseEntity<ClaimCaseDTO> rejectClaimCase(...) {
    log.warn("Direct reject is deprecated. Please complete the approval task.");
    throw new UnsupportedOperationException("Direct reject is deprecated");
}

/**
 * @deprecated æ”¯ä»˜é€šè¿‡BPMNæµç¨‹å®ç°
 */
@Deprecated
@PostMapping("/{id}/pay")
@Operation(
    summary = "æ”¯ä»˜ç†èµ”æ¡ˆä»¶ï¼ˆå·²åºŸå¼ƒï¼‰", 
    description = "ã€å·²åºŸå¼ƒã€‘æ”¯ä»˜é€šè¿‡BPMNæ”¯ä»˜æµç¨‹å¤„ç†"
)
public ResponseEntity<ClaimCaseDTO> payClaimCase(...) {
    log.warn("Direct pay is deprecated. Please use the BPMN payment process.");
    throw new UnsupportedOperationException("Direct pay is deprecated");
}
```

#### 6.3.2 å‰ç«¯æ”¹è¿›

**1. ç§»é™¤ç›´æ¥çŠ¶æ€å˜æ›´æŒ‰é’®**

```typescript
// ClaimDetail.tsx

// âŒ ç§»é™¤è¿™äº›æŒ‰é’®
// {claim.status === 'APPROVED' && (
//   <Button type="primary" onClick={handlePay}>æ”¯ä»˜</Button>
// )}

// {claim.status === 'UNDER_REVIEW' && (
//   <Space>
//     <Button type="primary" onClick={handleApprove}>æ‰¹å‡†</Button>
//     <Button danger onClick={handleReject}>æ‹’ç»</Button>
//   </Space>
// )}

// âœ… åªæ˜¾ç¤ºçŠ¶æ€å’Œä»»åŠ¡å¡ç‰‡
<div>
  <Tag color={getStatusColor(claim.status)}>
    {getStatusText(claim.status)}
  </Tag>
</div>

// âœ… æ˜¾ç¤ºå¾…åŠä»»åŠ¡
{currentTask && (
  <Card title="å¾…åŠä»»åŠ¡">
    {/* ä»»åŠ¡å¡ç‰‡å†…å®¹ */}
  </Card>
)}
```

**2. ä¿®æ”¹APIè°ƒç”¨**

```typescript
// frontend/src/services/api.ts

// âŒ ç§»é™¤è¿™äº›æ–¹æ³•
// updateClaimCaseStatus: (id: string, status: string, description?: string, userId?: string) => 
//   axios.post(`/api/cases/${id}/status`, null, { params: { status, description, userId } }),
// approveClaimCase: (id: string, userId: string, data: ApproveRequestDTO) => 
//   axios.post(`/api/cases/${id}/approve?userId=${userId}`, data),
// rejectClaimCase: (id: string, reason: string) => 
//   axios.post(`/api/cases/${id}/reject`, { reason }),
// payClaim: (id: string, data: PaymentRequestDTO) => 
//   axios.post(`/api/cases/${id}/pay`, data),

// âœ… ä¿ç•™ä»»åŠ¡ç›¸å…³æ–¹æ³•
const taskApi = {
  completeTask: (taskId: string, variables?: Record<string, any>) => 
    axios.post(`/api/tasks/${taskId}/complete`, variables),
  
  getTaskVariables: (taskId: string) => 
    axios.get(`/api/tasks/${taskId}/variables`),
  
  getTasksByCaseInstanceId: (caseInstanceId?: string) => 
    axios.get(`/api/tasks/by-case/${caseInstanceId}`),
};
```

#### 6.3.3 æ•°æ®æµéªŒè¯

**æ­£ç¡®çš„æ•°æ®æµï¼š**

```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡»"æ‰¹å‡†"æŒ‰é’®
    â†“
å‰ç«¯è°ƒç”¨: taskApi.completeTask(taskId, { approved: true, approvedAmount: 100000 })
    â†“
åç«¯å¤„ç†: TaskResource.completeTask()
    â†“
Flowableå¼•æ“: å®Œæˆå®¡æ‰¹ä»»åŠ¡
    â†“
CMMNæµç¨‹: æµç¨‹è‡ªåŠ¨æµè½¬åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    â†“
ç›‘å¬å™¨è§¦å‘: cmmnStageListener.notify() (event=complete)
    â†“
çŠ¶æ€æ›´æ–°: claimCase.setStatus(ClaimStatus.APPROVED)
    â†“
æ•°æ®åº“æ›´æ–°: claimCaseRepository.save(claimCase)
    â†“
å‰ç«¯åˆ·æ–°: é‡æ–°åŠ è½½ClaimDetail
    â†“
ç•Œé¢æ›´æ–°: æ˜¾ç¤ºAPPROVEDçŠ¶æ€ï¼Œæ˜¾ç¤ºæ”¯ä»˜ä»»åŠ¡
```

**é”™è¯¯çš„æ•°æ®æµï¼ˆå·²åºŸå¼ƒï¼‰ï¼š**

```
âŒ ç”¨æˆ·æ“ä½œ: ç‚¹å‡»"æ‰¹å‡†"æŒ‰é’®
âŒ å‰ç«¯è°ƒç”¨: claimApi.approveClaimCase(id, userId, data)
âŒ åç«¯å¤„ç†: CaseResource.approveClaimCase()
âŒ ç›´æ¥ä¿®æ”¹: caseService.approveClaimCase()
âŒ çŠ¶æ€æ›´æ–°: claimCase.setStatus(ClaimStatus.APPROVED)
âŒ æ•°æ®åº“æ›´æ–°: claimCaseRepository.save(claimCase)
âŒ æµç¨‹å¼•æ“: å®Œå…¨æœªå‚ä¸ï¼ŒçŠ¶æ€ä¸åŒæ­¥
```

### 6.4 ä¼˜åŠ¿æ€»ç»“

#### ä¼˜åŠ¿1ï¼šå•ä¸€çœŸç›¸æ¥æº

- **æµç¨‹å¼•æ“æ˜¯çŠ¶æ€çš„å†³å®šè€…**
- æ•°æ®åº“çŠ¶æ€æ˜¯æµç¨‹çŠ¶æ€çš„æŠ•å½±
- ä¸å­˜åœ¨"ä¸¤ä¸ªçŠ¶æ€ç³»ç»Ÿ"

#### ä¼˜åŠ¿2ï¼šè‡ªåŠ¨åŒæ­¥

- çŠ¶æ€å˜æ›´ç”±æµç¨‹å¼•æ“è‡ªåŠ¨è§¦å‘
- ç›‘å¬å™¨è´Ÿè´£åŒæ­¥åˆ°æ•°æ®åº“
- æ— éœ€æ‰‹åŠ¨è°ƒç”¨æ›´æ–°API

#### ä¼˜åŠ¿3ï¼šå¯è¿½æº¯æ€§

- æ‰€æœ‰çŠ¶æ€å˜æ›´éƒ½åœ¨æµç¨‹å†å²ä¸­è®°å½•
- å¯ä»¥é€šè¿‡Flowable APIæŸ¥è¯¢çŠ¶æ€å˜æ›´å†å²
- å®Œæ•´çš„å®¡è®¡è¿½è¸ª

#### ä¼˜åŠ¿4ï¼šä¸€è‡´æ€§ä¿è¯

- æµç¨‹çŠ¶æ€å’Œæ•°æ®åº“çŠ¶æ€å§‹ç»ˆä¸€è‡´
- ä¸ä¼šå‡ºç°"çŠ¶æ€æ¼‚ç§»"
- å‡å°‘æ•°æ®ä¸ä¸€è‡´çš„bug

#### ä¼˜åŠ¿5ï¼šæ˜“äºç»´æŠ¤

- çŠ¶æ€é€»è¾‘é›†ä¸­åœ¨æµç¨‹æ¨¡å‹ä¸­
- ä¿®æ”¹æµç¨‹å³å¯ä¿®æ”¹çŠ¶æ€æµè½¬
- ä»£ç æ›´ç®€æ´

#### ä¼˜åŠ¿6ï¼šä¸šåŠ¡é€»è¾‘æ¸…æ™°

- çŠ¶æ€æµè½¬ä¸ä¸šåŠ¡æµç¨‹å®Œå…¨å¯¹åº”
- å¯è§†åŒ–æµç¨‹å›¾
- éæŠ€æœ¯äººå‘˜ä¹Ÿèƒ½ç†è§£

### 6.5 æ½œåœ¨æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

#### æŒ‘æˆ˜1ï¼šç›‘å¬å™¨æ€§èƒ½

**é—®é¢˜ï¼š**
- å¤§é‡ç›‘å¬å™¨å¯èƒ½å½±å“æ€§èƒ½
- ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸åŒæ­¥

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨å¼‚æ­¥ç›‘å¬å™¨ï¼ˆasync=trueï¼‰
- æ·»åŠ é‡è¯•æœºåˆ¶
- ä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- æ·»åŠ ç›‘æ§å’Œå‘Šè­¦

#### æŒ‘æˆ˜2ï¼šå†å²æ•°æ®å¤„ç†

**é—®é¢˜ï¼š**
- ç°æœ‰æ•°æ®å¯èƒ½æ˜¯é€šè¿‡æ—§APIåˆ›å»ºçš„
- æ²¡æœ‰å¯¹åº”çš„æµç¨‹å®ä¾‹

**è§£å†³æ–¹æ¡ˆï¼š**
- æ ‡è®°ä¸º"å†å²æ•°æ®"
- ç¦ç”¨å¯¹æ—§æ•°æ®çš„æµç¨‹æ“ä½œ
- æä¾›æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰

#### æŒ‘æˆ˜3ï¼šæµ‹è¯•å¤æ‚åº¦

**é—®é¢˜ï¼š**
- éœ€è¦æµ‹è¯•æµç¨‹å¼•æ“å’Œæ•°æ®åº“çš„äº¤äº’
- é›†æˆæµ‹è¯•æ›´å¤æ‚

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨Flowableçš„æµ‹è¯•æ”¯æŒ
- Mockæ•°æ®åº“æ“ä½œ
- ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•

#### æŒ‘æˆ˜4ï¼šè°ƒè¯•éš¾åº¦

**é—®é¢˜ï¼š**
- çŠ¶æ€å˜æ›´ç”±ç›‘å¬å™¨è§¦å‘ï¼Œè°ƒè¯•æ›´å›°éš¾
- éœ€è¦ç†è§£æµç¨‹å¼•æ“çš„äº‹ä»¶æœºåˆ¶

**è§£å†³æ–¹æ¡ˆï¼š**
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—
- ä½¿ç”¨Flowable Adminç•Œé¢æŸ¥çœ‹æµç¨‹çŠ¶æ€
- ç¼–å†™ç›‘æ§é¢æ¿

### 6.6 å®æ–½æ£€æŸ¥æ¸…å•

**åç«¯å®æ–½ï¼š**
- [ ] æ‰©å±•PaymentUpdateServiceï¼Œæ·»åŠ å®Œæ•´çš„çŠ¶æ€æ›´æ–°é€»è¾‘
- [ ] å®Œå–„PaymentCompletionListenerï¼Œå¤„ç†æ”¯ä»˜å®Œæˆé€»è¾‘
- [ ] åˆ›å»ºCmmnStageListenerï¼Œç›‘å¬CMMNé˜¶æ®µå˜åŒ–
- [ ] åœ¨CMMNæ¨¡å‹ä¸­æ³¨å†Œç›‘å¬å™¨
- [ ] åºŸå¼ƒç›´æ¥æ›´æ–°çŠ¶æ€çš„APIï¼Œæ ‡è®°ä¸º@Deprecated
- [ ] æ·»åŠ æ—¥å¿—å’Œç›‘æ§

**å‰ç«¯å®æ–½ï¼š**
- [ ] ç§»é™¤ç›´æ¥çŠ¶æ€å˜æ›´æŒ‰é’®
- [ ] ç§»é™¤ç›´æ¥çŠ¶æ€å˜æ›´APIè°ƒç”¨
- [ ] é›†æˆä»»åŠ¡å¤„ç†åˆ°ç†èµ”è¯¦æƒ…é¡µ
- [ ] æ·»åŠ BPMNæµç¨‹å¯è§†åŒ–
- [ ] æ·»åŠ å®æ—¶çŠ¶æ€æ›´æ–°ï¼ˆå¯é€‰ï¼‰

**æµ‹è¯•ï¼š**
- [ ] ç¼–å†™ç›‘å¬å™¨å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ŒéªŒè¯æµç¨‹çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€åŒæ­¥
- [ ] ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•ï¼ŒéªŒè¯å®Œæ•´ä¸šåŠ¡æµç¨‹
- [ ] æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç†ï¼ˆç›‘å¬å™¨å¤±è´¥ç­‰ï¼‰

**æ–‡æ¡£ï¼š**
- [ ] æ›´æ–°APIæ–‡æ¡£ï¼Œæ ‡è®°åºŸå¼ƒçš„æ–¹æ³•
- [ ] ç¼–å†™æ¶æ„æ–‡æ¡£ï¼Œè¯´æ˜çŠ¶æ€ç®¡ç†æœºåˆ¶
- [ ] ç¼–å†™å¼€å‘è€…æŒ‡å—ï¼Œè¯´æ˜å¦‚ä½•æ­£ç¡®å¤„ç†ä»»åŠ¡
- [ ] æ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼Œè¯´æ˜æ–°çš„æ“ä½œæµç¨‹

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒé—®é¢˜

1. **ä¸¤å¥—ç‹¬ç«‹çš„æ”¯ä»˜ç³»ç»Ÿ** - ç†èµ”è¯¦æƒ…é¡µçš„ç›´æ¥æ”¯ä»˜å’ŒBPMNæ”¯ä»˜æµç¨‹å¹¶è¡Œè¿è¡Œ
2. **çŠ¶æ€å˜æ›´çš„åŒé‡å…¥å£** - å¯ä»¥é€šè¿‡ä»»åŠ¡å¤„ç†æˆ–ç›´æ¥APIä¿®æ”¹çŠ¶æ€
3. **çŠ¶æ€ä¸ä¸€è‡´** - æµç¨‹çŠ¶æ€å’Œæ•°æ®åº“çŠ¶æ€æ²¡æœ‰æ­£ç¡®åŒæ­¥
4. **æ•°æ®å†—ä½™** - æ”¯ä»˜ä¿¡æ¯åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å­˜å‚¨
5. **ç”¨æˆ·ä½“éªŒå·®** - æ”¯ä»˜æ“ä½œåˆ†æ•£ï¼Œæµç¨‹ä¸æ¸…æ™°

### 7.2 æ¨èæ–¹æ¡ˆ

**å®Œå…¨åŸºäºæµç¨‹é©±åŠ¨çš„çŠ¶æ€ç®¡ç†ï¼š**

**æ ¸å¿ƒæ”¹è¿›ï¼š**
1. âœ… ç§»é™¤æ‰€æœ‰ç›´æ¥æ›´æ–°çŠ¶æ€çš„API
2. âœ… æ‰€æœ‰çŠ¶æ€å˜æ›´ç”±æµç¨‹å¼•æ“æ§åˆ¶
3. âœ… åœ¨å…³é”®èŠ‚ç‚¹æ·»åŠ ç›‘å¬å™¨
4. âœ… ç›‘å¬å™¨è´Ÿè´£åŒæ­¥æµç¨‹çŠ¶æ€åˆ°æ•°æ®åº“
5. âœ… å‰ç«¯åªè¯»å–çŠ¶æ€ï¼Œä¸ç›´æ¥ä¿®æ”¹
6. âœ… é›†æˆä»»åŠ¡å¤„ç†åˆ°ç†èµ”è¯¦æƒ…é¡µ
7. âœ… é›†æˆBPMNæµç¨‹å¯è§†åŒ–

**æ¶æ„åŸåˆ™ï¼š**
- **å•ä¸€çœŸç›¸æ¥æº** - æµç¨‹å¼•æ“æ˜¯çŠ¶æ€çš„å†³å®šè€…
- **å•å‘æ•°æ®æµ** - ç”¨æˆ·æ“ä½œ â†’ å®Œæˆä»»åŠ¡ â†’ æµç¨‹æµè½¬ â†’ ç›‘å¬å™¨è§¦å‘ â†’ æ›´æ–°æ•°æ®åº“
- **äº‹ä»¶é©±åŠ¨** - ä½¿ç”¨Flowableçš„äº‹ä»¶æœºåˆ¶è‡ªåŠ¨åŒæ­¥çŠ¶æ€

### 7.3 é¢„æœŸæ•ˆæœ

1. **å®Œå…¨ç»Ÿä¸€çš„æ”¯ä»˜æµç¨‹** - æ‰€æœ‰æ”¯ä»˜éƒ½é€šè¿‡BPMNæµç¨‹
2. **è‡ªåŠ¨çŠ¶æ€åŒæ­¥** - æ— éœ€æ‰‹åŠ¨æ›´æ–°ï¼Œç›‘å¬å™¨è‡ªåŠ¨å¤„ç†
3. **é›¶è·³è½¬ä½“éªŒ** - ç†èµ”å‘˜åœ¨åŒä¸€é¡µé¢å®Œæˆæ‰€æœ‰æ“ä½œ
4. **å®Œæ•´çš„ä¸Šä¸‹æ–‡** - å¤„ç†ä»»åŠ¡æ—¶å§‹ç»ˆèƒ½çœ‹åˆ°å®Œæ•´çš„ç†èµ”ä¿¡æ¯
5. **å®æ—¶çŠ¶æ€å¯è§†åŒ–** - ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ”¯ä»˜è¿›åº¦å’Œå½“å‰é˜¶æ®µ
6. **æ•°æ®ä¸€è‡´æ€§ä¿è¯** - æµç¨‹çŠ¶æ€å’Œæ•°æ®åº“çŠ¶æ€å§‹ç»ˆä¸€è‡´
7. **å¯è¿½æº¯æ€§å¼º** - æ‰€æœ‰çŠ¶æ€å˜æ›´éƒ½åœ¨æµç¨‹å†å²ä¸­è®°å½•
8. **æ˜“äºç»´æŠ¤** - çŠ¶æ€é€»è¾‘é›†ä¸­åœ¨æµç¨‹æ¨¡å‹ä¸­

### 6.2 æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ2ï¼šå®Œå…¨åŸºäºBPMNæµç¨‹ + ä»»åŠ¡ä¸­å¿ƒä¸ç†èµ”è¯¦æƒ…åˆå¹¶ï¼š**

**æ ¸å¿ƒæ”¹è¿›ï¼š**
1. ç§»é™¤ç†èµ”è¯¦æƒ…é¡µçš„ç›´æ¥æ”¯ä»˜åŠŸèƒ½
2. è®©BPMNæ”¯ä»˜æµç¨‹æˆä¸ºå”¯ä¸€çš„æ”¯ä»˜è·¯å¾„
3. åœ¨ç†èµ”è¯¦æƒ…é¡µé›†æˆBPMNå­æµç¨‹å¯è§†åŒ–
4. å°†ä»»åŠ¡å¤„ç†åŠŸèƒ½é›†æˆåˆ°ç†èµ”è¯¦æƒ…é¡µä¸­
5. å»ºç«‹ç†èµ”çŠ¶æ€ä¸BPMNæµç¨‹çŠ¶æ€çš„æ˜ å°„å…³ç³»

**ç”¨æˆ·ä½“éªŒäº®ç‚¹ï¼š**
- ç†èµ”å‘˜æ‰“å¼€ç†èµ”è¯¦æƒ…é¡µå³å¯çœ‹åˆ°æ‰€æœ‰å¾…åŠä»»åŠ¡
- ç‚¹å‡»ä»»åŠ¡å³å¯å¤„ç†ï¼Œæ— éœ€è·³è½¬é¡µé¢
- å¤„ç†ä»»åŠ¡æ—¶èƒ½çœ‹åˆ°å®Œæ•´çš„ç†èµ”ä¸Šä¸‹æ–‡
- æ”¯ä»˜è¿›åº¦å®æ—¶å¯è§†åŒ–

### 6.3 é¢„æœŸæ•ˆæœ

1. **ç»Ÿä¸€çš„æ”¯ä»˜æµç¨‹**ï¼šæ‰€æœ‰æ”¯ä»˜éƒ½é€šè¿‡BPMNæµç¨‹ï¼Œæµç¨‹æ¸…æ™°å¯è¿½è¸ª
2. **é›¶è·³è½¬ä½“éªŒ**ï¼šç†èµ”å‘˜åœ¨åŒä¸€é¡µé¢å®Œæˆæ‰€æœ‰æ“ä½œï¼Œæ— éœ€åœ¨é¡µé¢é—´åˆ‡æ¢
3. **å®Œæ•´çš„ä¸Šä¸‹æ–‡**ï¼šå¤„ç†ä»»åŠ¡æ—¶å§‹ç»ˆèƒ½çœ‹åˆ°å®Œæ•´çš„ç†èµ”ä¿¡æ¯
4. **å®æ—¶çŠ¶æ€å¯è§†åŒ–**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°æ”¯ä»˜è¿›åº¦å’Œå½“å‰é˜¶æ®µ
5. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ”¯ä»˜ä¿¡æ¯åªå­˜å‚¨åœ¨æµç¨‹å˜é‡ä¸­ï¼Œç†èµ”çŠ¶æ€ä»æµç¨‹åŒæ­¥
6. **æ˜¾è‘—æå‡æ•ˆç‡**ï¼šå‡å°‘æ“ä½œæ­¥éª¤ï¼Œæé«˜å·¥ä½œæ•ˆç‡

### 6.4 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. ä¸å›¢é˜Ÿè®¨è®ºæœ¬åˆ†ææŠ¥å‘Š
2. ç¡®è®¤æ”¹è¿›æ–¹æ¡ˆ
3. åˆ¶å®šè¯¦ç»†çš„å®æ–½è®¡åˆ’
4. å¼€å§‹å®æ–½åç«¯æ”¹è¿›
5. å®æ–½å‰ç«¯æ”¹è¿›
6. æµ‹è¯•å’Œæ–‡æ¡£æ›´æ–°

---

## é™„å½•ï¼šç›¸å…³æ–‡ä»¶æ¸…å•

### æµç¨‹æ¨¡å‹æ–‡ä»¶
- `backend/src/main/resources/processes/ClaimPaymentProcess.bpmn` - BPMNæ”¯ä»˜æµç¨‹
- `backend/src/main/resources/cases/ClaimCase.cmmn` - CMMNæ¡ˆä¾‹æ¨¡å‹

### åç«¯ä»£ç æ–‡ä»¶
- `backend/src/main/java/com/flowable/demo/service/CaseService.java` - ç†èµ”æœåŠ¡
- `backend/src/main/java/com/flowable/demo/service/PaymentService.java` - æ”¯ä»˜æœåŠ¡
- `backend/src/main/java/com/flowable/demo/service/PaymentUpdateService.java` - æ”¯ä»˜æ›´æ–°æœåŠ¡
- `backend/src/main/java/com/flowable/demo/web/rest/CaseResource.java` - ç†èµ”API

### å‰ç«¯ä»£ç æ–‡ä»¶
- `frontend/src/components/ClaimDetail.tsx` - ç†èµ”è¯¦æƒ…é¡µ
- `frontend/src/components/TaskList.tsx` - ä»»åŠ¡åˆ—è¡¨é¡µ
- `frontend/src/components/admin/BpmnSubprocessVisualizer.tsx` - BPMNæµç¨‹å¯è§†åŒ–ç»„ä»¶

### æ–‡æ¡£æ–‡ä»¶
- `docs/payment-process-ui-interaction-analysis.md` - æ”¯ä»˜æµç¨‹UIäº¤äº’åˆ†æ
- `docs/payment-subprocess-implementation-summary.md` - æ”¯ä»˜å­æµç¨‹å®ç°æ€»ç»“
- `docs/bpmn-subprocess-visualization-implementation.md` - BPMNå­æµç¨‹å¯è§†åŒ–å®ç°
